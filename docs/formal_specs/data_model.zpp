--------------------------------------------------------------------------------
-- ElizaOS C++ Data Model Formal Specification
-- Z++ Specification Language
-- Version: 1.0.0
-- Date: December 12, 2024
--------------------------------------------------------------------------------

-- This specification formalizes the data layer of the ElizaOS C++ framework,
-- including all core data structures, types, and their invariants.

--------------------------------------------------------------------------------
-- BASIC TYPES
--------------------------------------------------------------------------------

[UUID, AgentId, ChannelId, ServerId, RoomId, WorldId, EntityId]
-- Basic identifier types as given sets

Timestamp == â„¤
-- Timestamp represented as Unix epoch time in milliseconds

EmbeddingVector == seq â„
-- Embedding vectors are sequences of real numbers (floats)

Content == seq Char
-- Text content as character sequences

--------------------------------------------------------------------------------
-- ENUMERATED TYPES
--------------------------------------------------------------------------------

MemoryType ::= DOCUMENT | FRAGMENT | MESSAGE | DESCRIPTION | CUSTOM

MemoryScope ::= SHARED | PRIVATE | ROOM

MessageType ::= TEXT | COMMAND | RESPONSE | STATUS | ERROR

TraitCategory ::= PERSONALITY | COGNITIVE | BEHAVIORAL | EMOTIONAL | 
                  SOCIAL | PHYSICAL | SKILL | PREFERENCE

TraitValueType ::= NUMERIC | CATEGORICAL | BOOLEAN | TEXT

TaskStatus ::= PENDING | IN_PROGRESS | COMPLETED | FAILED | CANCELLED

AgentStatus ::= IDLE | PROCESSING | WAITING | ACTIVE | SUSPENDED

--------------------------------------------------------------------------------
-- METADATA STRUCTURES
--------------------------------------------------------------------------------

-- Base metadata common to all memory types
schema BaseMetadata
  type: MemoryType
  source: â„™ Content
  sourceId: â„™ UUID
  scope: â„™ MemoryScope
  timestamp: â„™ Timestamp
  tags: seq Content
where
  -- Source and sourceId are optional (represented as power sets)
  #source â‰¤ 1
  #sourceId â‰¤ 1
  #scope â‰¤ 1
  #timestamp â‰¤ 1
end

-- Document metadata
schema DocumentMetadata
  BaseMetadata
where
  type = DOCUMENT
end

-- Fragment metadata with document reference and position
schema FragmentMetadata
  BaseMetadata
  documentId: UUID
  position: â„•
where
  type = FRAGMENT
  position â‰¥ 0
end

-- Message metadata
schema MessageMetadata
  BaseMetadata
where
  type = MESSAGE
end

-- Description metadata
schema DescriptionMetadata
  BaseMetadata
where
  type = DESCRIPTION
end

-- Custom metadata with key-value pairs
schema CustomMetadata
  BaseMetadata
  customData: Content â†” Content
where
  type = CUSTOM
  -- customData is a partial function from keys to values
  dom customData â‰  âˆ… â‡’ ran customData â‰  âˆ…
end

-- Union type for metadata
MetadataUnion ::= documentâŸ¨âŸ¨DocumentMetadataâŸ©âŸ© 
                | fragmentâŸ¨âŸ¨FragmentMetadataâŸ©âŸ©
                | messageâŸ¨âŸ¨MessageMetadataâŸ©âŸ©
                | descriptionâŸ¨âŸ¨DescriptionMetadataâŸ©âŸ©
                | customâŸ¨âŸ¨CustomMetadataâŸ©âŸ©

--------------------------------------------------------------------------------
-- CORE DATA STRUCTURES
--------------------------------------------------------------------------------

-- Memory record structure
schema Memory
  id: UUID
  content: Content
  entityId: EntityId
  agentId: AgentId
  roomId: â„™ RoomId
  worldId: â„™ WorldId
  embedding: â„™ EmbeddingVector
  metadata: MetadataUnion
  createdAt: Timestamp
  updatedAt: â„™ Timestamp
where
  -- Content must not be empty
  #content > 0
  
  -- Optional fields
  #roomId â‰¤ 1
  #worldId â‰¤ 1
  #embedding â‰¤ 1
  #updatedAt â‰¤ 1
  
  -- If embedding exists, it must have positive dimension
  embedding â‰  âˆ… â‡’ #(â‹ƒ embedding) > 0
  
  -- CreatedAt must be before updatedAt if updatedAt exists
  updatedAt â‰  âˆ… â‡’ createdAt â‰¤ (â‹ƒ updatedAt)
end

-- Message structure for agent communication
schema Message
  id: UUID
  type: MessageType
  sender: AgentId
  receiver: AgentId
  channelId: ChannelId
  serverId: ServerId
  content: Content
  metadata: Content â†” Content
  timestamp: Timestamp
  inReplyToMessageId: â„™ UUID
  sourceType: Content
where
  -- Content cannot be empty for TEXT and RESPONSE messages
  (type = TEXT âˆ¨ type = RESPONSE) â‡’ #content > 0
  
  -- Sender and receiver must be different
  sender â‰  receiver
  
  -- Optional reply reference
  #inReplyToMessageId â‰¤ 1
  
  -- Timestamp must be non-negative
  timestamp â‰¥ 0
end

-- Truth value for probabilistic logic (PLN integration)
schema TruthValue
  strength: â„
  confidence: â„
where
  -- Both values must be in [0, 1] range
  0 â‰¤ strength â‰¤ 1
  0 â‰¤ confidence â‰¤ 1
end

-- Hypergraph node for knowledge representation
schema HypergraphNode
  id: UUID
  label: Content
  attributes: Content â†” Content
  truthValue: â„™ TruthValue
  sti: â„  -- Short-term importance
  lti: â„  -- Long-term importance
where
  -- Label must not be empty
  #label > 0
  
  -- Optional truth value
  #truthValue â‰¤ 1
  
  -- Attention values must be non-negative
  sti â‰¥ 0
  lti â‰¥ 0
  
  -- Attributes is a partial function
  dom attributes âŠ† ran attributes â‡’ attributes âˆˆ Content â‡¸ Content
end

-- Hypergraph edge connecting multiple nodes
schema HypergraphEdge
  id: UUID
  label: Content
  nodeIds: seq UUID
  truthValue: â„™ TruthValue
  sti: â„
  lti: â„
where
  -- Label must not be empty
  #label > 0
  
  -- Edge must connect at least 2 nodes
  #nodeIds â‰¥ 2
  
  -- All node IDs must be unique
  #(â‹ƒ ran nodeIds) = #nodeIds
  
  -- Optional truth value
  #truthValue â‰¤ 1
  
  -- Attention values must be non-negative
  sti â‰¥ 0
  lti â‰¥ 0
end

--------------------------------------------------------------------------------
-- CHARACTER AND PERSONALITY STRUCTURES
--------------------------------------------------------------------------------

-- Personality matrix based on Big Five model
schema PersonalityMatrix
  openness: â„
  conscientiousness: â„
  extraversion: â„
  agreeableness: â„
  neuroticism: â„
  creativity: â„
  empathy: â„
  assertiveness: â„
  curiosity: â„
  loyalty: â„
where
  -- All traits must be in [0, 1] range
  0 â‰¤ openness â‰¤ 1
  0 â‰¤ conscientiousness â‰¤ 1
  0 â‰¤ extraversion â‰¤ 1
  0 â‰¤ agreeableness â‰¤ 1
  0 â‰¤ neuroticism â‰¤ 1
  0 â‰¤ creativity â‰¤ 1
  0 â‰¤ empathy â‰¤ 1
  0 â‰¤ assertiveness â‰¤ 1
  0 â‰¤ curiosity â‰¤ 1
  0 â‰¤ loyalty â‰¤ 1
end

-- Emotional state tracking
schema EmotionalState
  happiness: â„
  sadness: â„
  anger: â„
  fear: â„
  surprise: â„
  disgust: â„
  excitement: â„
  calmness: â„
where
  -- All emotions must be in [0, 1] range
  0 â‰¤ happiness â‰¤ 1
  0 â‰¤ sadness â‰¤ 1
  0 â‰¤ anger â‰¤ 1
  0 â‰¤ fear â‰¤ 1
  0 â‰¤ surprise â‰¤ 1
  0 â‰¤ disgust â‰¤ 1
  0 â‰¤ excitement â‰¤ 1
  0 â‰¤ calmness â‰¤ 1
  
  -- Emotional consistency constraints
  -- Opposing emotions have inverse relationship
  happiness + sadness â‰¤ 1.2
  excitement + calmness â‰¤ 1.2
end

-- Character trait value (polymorphic)
TraitValue ::= numericâŸ¨âŸ¨â„âŸ©âŸ© 
             | categoricalâŸ¨âŸ¨ContentâŸ©âŸ©
             | booleanâŸ¨âŸ¨ð”¹âŸ©âŸ©
             | textâŸ¨âŸ¨ContentâŸ©âŸ©

-- Character trait definition
schema CharacterTrait
  name: Content
  description: Content
  category: TraitCategory
  valueType: TraitValueType
  value: TraitValue
  weight: â„
  tags: seq Content
  metadata: Content â†” Content
where
  -- Name and description must not be empty
  #name > 0
  #description > 0
  
  -- Weight must be in [0, 1] range
  0 â‰¤ weight â‰¤ 1
  
  -- Value type must match value variant
  (valueType = NUMERIC â‡’ value âˆˆ numericâŸ¨âŸ¨â„âŸ©âŸ©) âˆ§
  (valueType = CATEGORICAL â‡’ value âˆˆ categoricalâŸ¨âŸ¨ContentâŸ©âŸ©) âˆ§
  (valueType = BOOLEAN â‡’ value âˆˆ booleanâŸ¨âŸ¨ð”¹âŸ©âŸ©) âˆ§
  (valueType = TEXT â‡’ value âˆˆ textâŸ¨âŸ¨ContentâŸ©âŸ©)
  
  -- For numeric traits, value must be in [0, 1]
  valueType = NUMERIC â‡’ 
    âˆƒ v: â„ | value = numericâŸ¨âŸ¨vâŸ©âŸ© â€¢ 0 â‰¤ v â‰¤ 1
end

-- Complete character profile
schema CharacterProfile
  id: UUID
  name: Content
  bio: â„™ Content
  lore: seq Content
  personality: PersonalityMatrix
  traits: seq CharacterTrait
  emotionalState: EmotionalState
  knowledge: â„™ UUID  -- References to knowledge base entries
  messageExamples: seq (Content Ã— Content)  -- Input-output pairs
  topics: seq Content
  adjectives: seq Content
  style: â„™ Content
where
  -- Name must not be empty
  #name > 0
  
  -- Optional bio
  #bio â‰¤ 1
  bio â‰  âˆ… â‡’ #(â‹ƒ bio) > 0
  
  -- Trait names must be unique
  âˆ€ i, j: dom traits | i â‰  j â€¢ 
    (traits(i)).name â‰  (traits(j)).name
  
  -- Topics and adjectives must not contain empty strings
  âˆ€ t: ran topics â€¢ #t > 0
  âˆ€ a: ran adjectives â€¢ #a > 0
  
  -- Optional style
  #style â‰¤ 1
  
  -- Message examples must have non-empty content
  âˆ€ (input, output): ran messageExamples â€¢ 
    #input > 0 âˆ§ #output > 0
end

--------------------------------------------------------------------------------
-- TASK AND GOAL STRUCTURES
--------------------------------------------------------------------------------

-- Actor in the system
schema Actor
  id: UUID
  name: Content
  username: â„™ Content
  details: â„™ Content
where
  #name > 0
  #username â‰¤ 1
  #details â‰¤ 1
end

-- Goal definition
schema Goal
  id: UUID
  name: Content
  description: â„™ Content
  priority: â„•
  status: TaskStatus
where
  #name > 0
  #description â‰¤ 1
  priority â‰¥ 0
end

-- Task definition
schema Task
  id: UUID
  name: Content
  description: â„™ Content
  status: TaskStatus
  priority: â„•
  roomId: â„™ RoomId
  worldId: â„™ WorldId
  createdAt: Timestamp
  updatedAt: Timestamp
  completedAt: â„™ Timestamp
  dependencies: seq UUID
where
  -- Name must not be empty
  #name > 0
  
  -- Optional description
  #description â‰¤ 1
  
  -- Priority must be non-negative
  priority â‰¥ 0
  
  -- Optional room and world IDs
  #roomId â‰¤ 1
  #worldId â‰¤ 1
  
  -- Timestamps must be ordered correctly
  createdAt â‰¤ updatedAt
  
  -- Optional completion timestamp
  #completedAt â‰¤ 1
  
  -- If completed, completedAt must exist and be after createdAt
  status = COMPLETED â‡’ 
    (completedAt â‰  âˆ… âˆ§ createdAt â‰¤ (â‹ƒ completedAt))
  
  -- Dependencies must be unique
  #(â‹ƒ ran dependencies) = #dependencies
end

--------------------------------------------------------------------------------
-- CONVERSATION STRUCTURES
--------------------------------------------------------------------------------

-- Conversation turn
schema ConversationTurn
  id: UUID
  input: Content
  response: Content
  timestamp: Timestamp
  emotionalState: Content
  metadata: Content â†” Content
  confidence: â„
where
  -- Input and response must not be empty
  #input > 0
  #response > 0
  
  -- Timestamp must be non-negative
  timestamp â‰¥ 0
  
  -- Confidence must be in [0, 1] range
  0 â‰¤ confidence â‰¤ 1
end

-- Conversation context
schema ConversationContext
  sessionId: UUID
  userId: UUID
  characterId: â„™ UUID
  history: seq ConversationTurn
  sessionData: Content â†” Content
  startTime: Timestamp
  lastActivity: Timestamp
where
  -- Optional character ID
  #characterId â‰¤ 1
  
  -- Timestamps must be ordered
  startTime â‰¤ lastActivity
  
  -- History turns must be in chronological order
  âˆ€ i, j: dom history | i < j â€¢ 
    (history(i)).timestamp â‰¤ (history(j)).timestamp
  
  -- All turn IDs in history must be unique
  âˆ€ i, j: dom history | i â‰  j â€¢ 
    (history(i)).id â‰  (history(j)).id
end

-- Response pattern for Eliza
schema ResponsePattern
  id: UUID
  pattern: Content  -- Regex pattern
  responses: seq Content
  category: Content
  priority: â„
  conditions: seq Content
  metadata: Content â†” Content
where
  -- Pattern must not be empty
  #pattern > 0
  
  -- Must have at least one response
  #responses â‰¥ 1
  
  -- All responses must be non-empty
  âˆ€ r: ran responses â€¢ #r > 0
  
  -- Priority must be positive
  priority > 0
  
  -- Category must not be empty
  #category > 0
end

--------------------------------------------------------------------------------
-- AGENT CONFIGURATION
--------------------------------------------------------------------------------

-- Agent configuration
schema AgentConfig
  agentId: UUID
  agentName: Content
  bio: â„™ Content
  lore: seq Content
  messageExamples: seq (Content Ã— Content)
  postExamples: seq Content
  topics: seq Content
  adjectives: seq Content
  plugins: seq Content
  settings: Content â†” Content
  style: â„™ Content
where
  -- Agent name must not be empty
  #agentName > 0
  
  -- Optional bio
  #bio â‰¤ 1
  bio â‰  âˆ… â‡’ #(â‹ƒ bio) > 0
  
  -- Optional style
  #style â‰¤ 1
  
  -- All example messages must be non-empty
  âˆ€ (input, output): ran messageExamples â€¢ 
    #input > 0 âˆ§ #output > 0
  
  -- All post examples must be non-empty
  âˆ€ p: ran postExamples â€¢ #p > 0
  
  -- Topics and adjectives must not be empty
  âˆ€ t: ran topics â€¢ #t > 0
  âˆ€ a: ran adjectives â€¢ #a > 0
end

--------------------------------------------------------------------------------
-- DATA INVARIANTS AND CONSTRAINTS
--------------------------------------------------------------------------------

-- Global uniqueness constraint for identifiers
schema UniqueIdentifiers
  allIds: â„™ UUID
  memoryIds: â„™ UUID
  messageIds: â„™ UUID
  nodeIds: â„™ UUID
  edgeIds: â„™ UUID
  taskIds: â„™ UUID
  agentIds: â„™ UUID
where
  -- All ID sets must be pairwise disjoint
  memoryIds âŠ† allIds
  messageIds âŠ† allIds
  nodeIds âŠ† allIds
  edgeIds âŠ† allIds
  taskIds âŠ† allIds
  agentIds âŠ† allIds
  
  -- Union of all ID sets equals all IDs
  allIds = memoryIds âˆª messageIds âˆª nodeIds âˆª edgeIds âˆª taskIds âˆª agentIds
end

-- Referential integrity for hypergraph
schema HypergraphIntegrity
  nodes: â„™ HypergraphNode
  edges: â„™ HypergraphEdge
where
  -- All edge node references must exist
  âˆ€ e: edges â€¢ âˆ€ nid: ran (e.nodeIds) â€¢ 
    âˆƒ n: nodes â€¢ n.id = nid
  
  -- No self-loops (edge connecting node to itself)
  âˆ€ e: edges â€¢ 
    #(â‹ƒ ran (e.nodeIds)) = #(e.nodeIds)
end

-- Temporal consistency for memories
schema TemporalConsistency
  memories: â„™ Memory
where
  -- For all memories, if updatedAt exists, it must be >= createdAt
  âˆ€ m: memories â€¢ 
    m.updatedAt â‰  âˆ… â‡’ m.createdAt â‰¤ (â‹ƒ m.updatedAt)
end

-- Memory embedding dimension consistency
schema EmbeddingConsistency
  embeddingDimension: â„•
  memories: â„™ Memory
where
  -- If dimension is set, all embeddings must match
  embeddingDimension > 0 â‡’
    âˆ€ m: memories | m.embedding â‰  âˆ… â€¢ 
      #(â‹ƒ m.embedding) = embeddingDimension
end

--------------------------------------------------------------------------------
-- END OF DATA MODEL SPECIFICATION
--------------------------------------------------------------------------------

-- This specification defines the complete data layer of ElizaOS C++.
-- All operations and system state definitions will build upon these
-- foundational data structures and their invariants.
