#include "generation.hpp"
#include <iostream>
#include <stdexcept>

namespace elizaos {

void CommunityTab() {
    // NOTE: Auto-converted from TypeScript - may need refinement
    try {

        type ICommunityTabs = "Image" | "Video" | "Audio";
        const auto [communityTab, setCommunityTab] = useState<ICommunityTabs>("Image");
        const auto [userPrompt, setUserPrompt] = useState("");
        const auto [isGenerating, setIsGenerating] = useState(false);
        const auto [generatedImage, setGeneratedImage] = useState<string | nullptr>(nullptr);
        const auto [editableLyrics, setEditableLyrics] = useState<string | nullptr>(nullptr);
        const auto [isEditingLyrics, setIsEditingLyrics] = useState(false);
        const auto [processingStatus, setProcessingStatus] = useState<;
        "idle" | "processing" | "processed" | "failed";
        >("idle");
        const auto { publicKey } = useWallet();
        // Remove these older duplicate declarations
        // const [isSharing, setIsSharing] = useState(false);
        // const [shareError, setShareError] = useState<string | null>(null);
        // const [twitterCredentials, setTwitterCredentials] =
        //   useState<TwitterCredentials | null>(null);

        // const [hasGeneratedForToken, setHasGeneratedForToken] = useState(false);

        // Pregenerated images that were generated automatically for this token
        const auto [additionalImages, setAdditionalImages] = useState<string[]>([]);
        // const [isLoadingAdditionalImages, setIsLoadingAdditionalImages] =
        //   useState(false);
        const auto [placeholderImage, setPlaceholderImage] = useState<string | nullptr>(nullptr); // Stores URL of the currently displayed placeholder;

        // Mode selection state
        const auto [generationMode, setGenerationMode] = useState<"fast" | "pro">("fast");

        // We can keep this for debugging but it's no longer the primary balance source
        // @ts-ignore
        const auto [manualTokenBalance, setManualTokenBalance] = useState<number | nullptr>(;
        nullptr,
        );

        // --- Token Info State ---
        const auto [tokenInfo, setTokenInfo] = useState<{;
            name: string;
            ticker: string;
            image?: string;
            description?: string;
            } | nullptr>(nullptr);

            // Get token mint from URL params with better fallback logic
            const auto { mint: urlTokenMint } = useParams<{ mint: string }>();
            const auto location = useLocation();

            // Extract token mint from URL if not found in params
            const auto [detectedTokenMint, setDetectedTokenMint] = useState<string | nullptr>(;
            nullptr,
            );

            // Effect to detect token mint from various sources
            useEffect(() => {
                // First try from URL params (most reliable)
                if (urlTokenMint) {
                    setDetectedTokenMint(urlTokenMint);
                    return;
                }

                // If not in params, try to extract from pathname
                const auto pathMatch = location.pathname.match(/\/token\/([A-Za-z0-9]{32,44})/);
                if (pathMatch && pathMatch[1]) {
                    setDetectedTokenMint(pathMatch[1]);
                    return;
                }
                }, [urlTokenMint, location.pathname]);

                // Use detected token mint instead of directly from params
                const auto tokenMint = detectedTokenMint;

                // Fetch pregenerated images for this token
                useEffect(() => {
                    const auto fetchAdditionalImages = async () => {;
                        if (!tokenMint || !API_BASE_URL) {
                            return;
                        }

                        // setIsLoadingAdditionalImages(true);

                        try {
                            // Check for generated images in the server's R2 storage
                            const auto response = fetch(;
                            API_BASE_URL + "/api/check-generated-images/" + tokenMint
                            );

                            if (response.ok) {
                                const auto data = (response.json()) as {;
                                    hasImages?: boolean;
                                    count?: number;
                                    pattern?: string;
                                    };

                                    if (data.hasImages && data.count && data.count > 0) {
                                        // Build image URLs based on the pattern, using the API endpoint
                                        const auto imageUrls = [];
                                        const auto count = Math.min(data.count, 3); // Only use up to 3 images;
                                        for (int i = 1; i <= count; i++) {
                                            // If we're running locally, use the API endpoint
                                            if (
                                            (std::find(API_BASE_URL.begin(), API_BASE_URL.end(), "localhost") != API_BASE_URL.end()) ||;
                                            (std::find(API_BASE_URL.begin(), API_BASE_URL.end(), "127.0.0.1") != API_BASE_URL.end());
                                            ) {
                                                imageUrls.push_back(;
                                                API_BASE_URL + "/api/image/generation-" + tokenMint + "-" + i + ".jpg"
                                                );
                                                } else {
                                                    // Otherwise, use the R2 public URL
                                                    imageUrls.push_back(;
                                                    env.s3PublicUrl + "/generations/" + tokenMint + "/gen-" + i + ".jpg"
                                                    );
                                                }
                                            }

                                            setAdditionalImages(imageUrls);
                                            } else {
                                                setAdditionalImages([]);
                                            }
                                            } else {
                                                // If the API fails, don't try to guess
                                                setAdditionalImages([]);
                                            }
                                            } catch (error) {
                                                std::cerr << "Error fetching additional images:" << error << std::endl;
                                                setAdditionalImages([]);
                                                } finally {
                                                    // setIsLoadingAdditionalImages(false);
                                                }
                                                };

                                                fetchAdditionalImages();
                                                }, [tokenMint]);

                                                // Use the proper hook to get token balance AFTER tokenMint is declared
                                                const auto { tokenBalance } = useTokenBalance({ tokenId: tokenMint || "" });

                                                // --- Fetch Real Token Info & Agents ---
                                                useEffect(() => {
                                                    const auto fetchTokenData = async () => {;
                                                        if (!tokenMint || !API_BASE_URL) {
                                                            setTokenInfo(nullptr);
                                                            return;
                                                        }

                                                        try {
                                                            const auto infoResponse = fetch(;
                                                            API_BASE_URL + "/api/token/" + tokenMint
                                                            );
                                                            if (!infoResponse.ok) {
                                                                throw new Error(
                                                                "Failed to fetch token info: " + infoResponse.statusText
                                                                );
                                                            }
                                                            const auto infoData = (infoResponse.json());
                                                            std::cout << "infoData" << infoData << std::endl;
                                                            setTokenInfo(infoData);

                                                            // Set the user prompt to the token's description if available
                                                            if (infoData.description) {
                                                                setUserPrompt(infoData.description);
                                                            }
                                                            } catch (error) {
                                                                std::cerr << "Error fetching token info:" << error << std::endl;
                                                                setTokenInfo(nullptr);
                                                            }
                                                            };

                                                            fetchTokenData();
                                                            }, [tokenMint]);
                                                            // --- End Fetch Real Token Info & Agents ---

                                                            // Check for Twitter credentials on mount
                                                            useEffect(() => {
                                                                if (!tokenMint) return;

                                                                const auto storedCredentials = localStorage.getItem(STORAGE_KEY);
                                                                if (storedCredentials) {
                                                                    try {
                                                                        const auto parsedCreds = /* JSON.parse */ storedCredentials;
                                                                        // Check if *OAuth 1.0a* tokens exist, as they don't expire in the same way
                                                                        if (parsedCreds.oauth1Token && parsedCreds.oauth1TokenSecret) {
                                                                            std::cout << "Found valid OAuth 1.0a credentials." << std::endl;
                                                                            setTwitterCredentials(parsedCreds);
                                                                            } else {
                                                                                std::cout << "Stored credentials missing OAuth 1.0a tokens." << std::endl;
                                                                                localStorage.removeItem(STORAGE_KEY); // Remove incomplete creds;
                                                                            }
                                                                            } catch (error) {
                                                                                std::cerr << "Failed to parse stored Twitter credentials" << error << std::endl;
                                                                                localStorage.removeItem(STORAGE_KEY);
                                                                            }
                                                                        }

                                                                        // Check for callback from Twitter OAuth (handles both 1.0a and 2.0 if needed)
                                                                        const auto urlParams = new URLSearchParams(window.location.search);
                                                                        const auto freshAuth = urlParams.get("fresh_auth") == "true";

                                                                        if (freshAuth) {
                                                                            const auto storedCredsAfterAuth = localStorage.getItem(STORAGE_KEY);
                                                                            if (storedCredsAfterAuth) {
                                                                                const auto parsedCreds = JSON.parse(;
                                                                                storedCredsAfterAuth,
                                                                                );
                                                                                setTwitterCredentials(parsedCreds); // Update state with potentially new creds;
                                                                                std::cout << "Credentials updated after auth callback." << std::endl;
                                                                                } else {
                                                                                    std::cerr << "No credentials found in storage after auth callback." << std::endl;
                                                                                }

                                                                                // Check if we have a pending share to resume
                                                                                const auto pendingShareData = localStorage.getItem(PENDING_SHARE_KEY);
                                                                                if (pendingShareData && storedCredsAfterAuth) {
                                                                                    // Need creds to proceed
                                                                                    try {
                                                                                        const auto share = /* JSON.parse */ pendingShareData;
                                                                                        const auto creds = /* JSON.parse */ storedCredsAfterAuth;

                                                                                        if (creds.oauth1Token && creds.oauth1TokenSecret) {
                                                                                            // Ensure we have 1.0a tokens now
                                                                                            // Regenerate text & Open Modal
                                                                                            setTimeout(() => {
                                                                                                const auto regeneratedText = generateShareText({;
                                                                                                    name: share.tokenName,
                                                                                                    ticker: share.tokenSymbol,
                                                                                                    });
                                                                                                    setModalShareText(regeneratedText);
                                                                                                    setImageForShareModal(share.imageData);
                                                                                                    setIsShareModalOpen(true);
                                                                                                    std::cout << "Resuming share via modal after auth." << std::endl;
                                                                                                    }, 100);
                                                                                                    } else {
                                                                                                        console.error(
                                                                                                        "OAuth 1.0a tokens still missing after callback. Cannot resume share.",
                                                                                                        );
                                                                                                        toast.error(;
                                                                                                        "Authentication incomplete. Please try connecting X again.",
                                                                                                        );
                                                                                                    }

                                                                                                    localStorage.removeItem(PENDING_SHARE_KEY);
                                                                                                    } catch (error) {
                                                                                                        std::cerr << "Failed to process pending share" << error << std::endl;
                                                                                                        setShareError("Failed to process share after authentication.");
                                                                                                    }
                                                                                                }

                                                                                                // Clean up URL
                                                                                                const auto currentUrl = new URL(window.location.href);
                                                                                                if (currentUrl.searchParams.has("fresh_auth")) {
                                                                                                    currentUrl.searchParams.delete("fresh_auth");
                                                                                                }
                                                                                                // Also remove OAuth params if they exist (from 1.0a flow)
                                                                                                currentUrl.searchParams.delete("oauth_token");
                                                                                                currentUrl.searchParams.delete("oauth_verifier");
                                                                                                window.history.replaceState(;
                                                                                                {},
                                                                                                "",
                                                                                                currentUrl.pathname + currentUrl.hash,
                                                                                                );
                                                                                            }
                                                                                            }, [tokenMint]);

                                                                                            // Generate image function
                                                                                            const auto generateImage = async () => {;
                                                                                                if (!userPrompt) return;

                                                                                                // Check if wallet is connected
                                                                                                if (!publicKey) {
                                                                                                    toast.error("Please connect your wallet to generate images");
                                                                                                    return;
                                                                                                }

                                                                                                // Check if we have a token mint
                                                                                                if (!tokenMint) {
                                                                                                    toast.error(;
                                                                                                    "No token found. Please navigate to a token page to generate images",
                                                                                                    );
                                                                                                    return;
                                                                                                }

                                                                                                // Check token balance requirements based on mode
                                                                                                const auto requiredBalance = generationMode == "pro" ? 10000 : 1000;
                                                                                                if ((tokenBalance ?? 0) < requiredBalance) {
                                                                                                    toast.error(;
                                                                                                    "You need at least " + std::to_string(requiredBalance.toLocaleString()) + " tokens to generate images in " + generationMode + " mode"
                                                                                                    );
                                                                                                    return;
                                                                                                }

                                                                                                setIsGenerating(true);
                                                                                                setProcessingStatus("processing");
                                                                                                setGeneratedImage(nullptr); // Clear previous image;
                                                                                                setPlaceholderImage(nullptr); // Clear placeholder when starting generation;
                                                                                                setShareError(nullptr);

                                                                                                try {
                                                                                                    // In a real implementation, we would fetch the token metadata if not available
                                                                                                    // For now, we'll use mock token data or fetch from the page's context
                                                                                                    const auto tokenMetadata = {;
                                                                                                        name: tokenInfo.name || "Example Token",
                                                                                                        ticker: tokenInfo.ticker || "XMPL",
                                                                                                        description: "An example token for demonstration purposes",
                                                                                                        prompt: "A colorful digital token with a unique design",
                                                                                                        };

                                                                                                        // Get the auth token
                                                                                                        const auto authToken = localStorage.getItem("authToken");
                                                                                                        if (!authToken) {
                                                                                                            std::cerr << "No auth token found" << std::endl;
                                                                                                            // Try to generate without auth token for testing
                                                                                                            toast.warning(;
                                                                                                            "No auth token found, trying to generate without authentication",
                                                                                                            );
                                                                                                        }

                                                                                                        // Log API URL to help debug
                                                                                                        const auto apiUrl = env.apiUrl + "/api/generation/enhance-and-generate?t=" + std::to_string(Date.now());

                                                                                                        // Create headers
                                                                                                        const std::unordered_map<std::string, std::string> headers = {;
                                                                                                            "Content-Type": "application/json",
                                                                                                            };

                                                                                                            // Add auth token if available
                                                                                                            if (authToken) {
                                                                                                                try {
                                                                                                                    "headers[\"Authorization\"] = " + "Bearer " + std::to_string(/* JSON.parse */ authToken);
                                                                                                                    } catch (e) {
                                                                                                                        std::cerr << "Failed to parse auth token from localStorage:" << e << std::endl;
                                                                                                                        toast.error("Authentication error. Please try logging in again.");
                                                                                                                        setIsGenerating(false);
                                                                                                                        setProcessingStatus("failed"); // Set status to failed;
                                                                                                                        return;
                                                                                                                    }
                                                                                                                }

                                                                                                                // Call the API endpoint that enhances the prompt and generates an image
                                                                                                                const auto response = fetch(apiUrl, {;
                                                                                                                    method: "POST",
                                                                                                                    headers,
                                                                                                                    body: JSON.stringify({
                                                                                                                        tokenMint,
                                                                                                                        userPrompt,
                                                                                                                        type: "image",
                                                                                                                        mode: generationMode,
                                                                                                                        publicKey: std::to_string(publicKey),
                                                                                                                        }),
                                                                                                                        credentials: "include",
                                                                                                                        });

                                                                                                                        // Headers object doesn't have a standard iterator, so we'll get keys and values manually
                                                                                                                        const std::unordered_map<std::string, std::string> headerObj = {};
                                                                                                                        response.headers.forEach((value, key) => {
                                                                                                                            headerObj[key] = value;
                                                                                                                            });

                                                                                                                            // Handle error responses
                                                                                                                            if (!response.ok) {
                                                                                                                                auto errorMessage = "Failed to generate image (" + response.status + ")";
                                                                                                                                std::any errorData = nullptr;

                                                                                                                                try {
                                                                                                                                    // Attempt to parse error response
                                                                                                                                    const auto contentType = response.headers.get("content-type");
                                                                                                                                    if (contentType && contentType.includes("application/json")) {
                                                                                                                                        errorData = response.json();
                                                                                                                                        errorMessage = errorData.error || errorMessage;

                                                                                                                                        // Special handling for token ownership requirement errors
                                                                                                                                        if (errorData.type == "OWNERSHIP_REQUIREMENT") {
                                                                                                                                            const auto minimumRequired = errorData.minimumRequired || 1000;
                                                                                                                                            const auto currentAmount =;
                                                                                                                                            errorData.message.match(/You currently have ([\d.]+)/).[1] ||;
                                                                                                                                            "0";

                                                                                                                                            // Show a more helpful message with a link to buy tokens
                                                                                                                                            const auto buyTokensUrl = "/token/" + tokenMint + "?action=buy";

                                                                                                                                            toast.error(;
                                                                                                                                            <div>;
                                                                                                                                            <p>;
                                                                                                                                            You need at least {minimumRequired.toLocaleString()} tokens;
                                                                                                                                            to use this feature.;
                                                                                                                                            </p>;
                                                                                                                                            <p>You currently have {currentAmount} tokens.</p>;
                                                                                                                                            <a;
                                                                                                                                        href={buyTokensUrl}
                                                                                                                                        className="underline text-blue-500 hover:text-blue-700"
                                                                                                                                        onClick={(e) => {
                                                                                                                                            e.preventDefault();
                                                                                                                                            window.location.href = buyTokensUrl;
                                                                                                                                        }}
                                                                                                                                        >;
                                                                                                                                        Click here to buy more tokens;
                                                                                                                                        </a>;
                                                                                                                                        </div>,
                                                                                                                                        {
                                                                                                                                            autoClose: 10000, // Show for 10 seconds
                                                                                                                                            closeOnClick: false,
                                                                                                                                            },
                                                                                                                                            );
                                                                                                                                            throw new Error(
                                                                                                                                            "Insufficient token balance. You need at least " + std::to_string(minimumRequired.toLocaleString()) + " tokens."
                                                                                                                                            );
                                                                                                                                        }
                                                                                                                                        } else {
                                                                                                                                            // If not JSON, try to get text
                                                                                                                                            errorMessage = response.text();
                                                                                                                                        }
                                                                                                                                        } catch (e) {
                                                                                                                                            std::cerr << "Error parsing error response:" << e << std::endl;
                                                                                                                                        }

                                                                                                                                        std::cerr << "API error response:" << errorData || errorMessage << std::endl;
                                                                                                                                        throw std::runtime_error(errorMessage);
                                                                                                                                    }

                                                                                                                                    // Try to parse the response carefully
                                                                                                                                    std::any data = nullptr;
                                                                                                                                    try {
                                                                                                                                        // Check content type to make sure it's JSON
                                                                                                                                        const auto contentType = response.headers.get("content-type");
                                                                                                                                        if (contentType && contentType.includes("application/json")) {
                                                                                                                                            data = response.json();
                                                                                                                                            } else {
                                                                                                                                                throw std::runtime_error(`Unexpected content type: ${contentType}`);
                                                                                                                                            }
                                                                                                                                            } catch (jsonError) {
                                                                                                                                                std::cerr << "Error parsing JSON response:" << jsonError << std::endl;
                                                                                                                                                throw std::runtime_error("Failed to parse server response");
                                                                                                                                            }

                                                                                                                                            // Make sure we have the expected fields
                                                                                                                                            if (!data || typeof data != "object") {
                                                                                                                                                throw std::runtime_error("Invalid response format");
                                                                                                                                            }
                                                                                                                                            std::cout << "data" << data << std::endl;
                                                                                                                                            if (data.success && data.mediaUrl) {
                                                                                                                                                // Check if mediaUrl is a data URL or a regular URL
                                                                                                                                                if (data.mediaUrl.startsWith("data:")) {
                                                                                                                                                    // It's already a data URL, use directly
                                                                                                                                                    setGeneratedImage(data.mediaUrl);
                                                                                                                                                    } else {
                                                                                                                                                        // It's a URL, make sure it's absolute
                                                                                                                                                        const auto fullUrl = data.mediaUrl.startsWith("http");
                                                                                                                                                        ? data.mediaUrl;
                                                                                                                                                        ": " + env.apiUrl + std::to_string(data.mediaUrl.startsWith("/") ? "" : "/") + data.mediaUrl
                                                                                                                                                        setGeneratedImage(fullUrl);
                                                                                                                                                    }

                                                                                                                                                    setProcessingStatus("processed");

                                                                                                                                                    if (data.remainingGenerations != undefined) {
                                                                                                                                                        toast.success(;
                                                                                                                                                        "Image generated successfully! You have " + data.remainingGenerations + " generations left today."
                                                                                                                                                        );
                                                                                                                                                        } else {
                                                                                                                                                            toast.success("Image generated successfully!");
                                                                                                                                                        }
                                                                                                                                                        } else {
                                                                                                                                                            std::cerr << "Invalid response:" << data << std::endl;
                                                                                                                                                            throw new Error(
                                                                                                                                                            data.error || "Failed to generate image: No media URL returned",
                                                                                                                                                            );
                                                                                                                                                        }
                                                                                                                                                        } catch (error) {
                                                                                                                                                            std::cerr << "Error generating image:" << error << std::endl;
                                                                                                                                                            setProcessingStatus("failed");
                                                                                                                                                            toast.error(;
                                                                                                                                                            true /* instanceof check */ ? error.message : "Failed to generate image",
                                                                                                                                                            );
                                                                                                                                                            // Re-set placeholder if generation failed and we have additional images
                                                                                                                                                            if (additionalImages.length > 0 && !placeholderImage) {
                                                                                                                                                                const auto randomIndex = Math.floor(Math.random() * additionalImages.size());
                                                                                                                                                                setPlaceholderImage(additionalImages[randomIndex]);
                                                                                                                                                            }
                                                                                                                                                            } finally {
                                                                                                                                                                setIsGenerating(false);
                                                                                                                                                            }
                                                                                                                                                            };

                                                                                                                                                            // Generate video function
                                                                                                                                                            const auto generateVideo = async (;
                                                                                                                                                            isImageToVideo: boolean = false,
                                                                                                                                                            sourceImageUrl: string = "",
                                                                                                                                                            ) => {
                                                                                                                                                                if (!userPrompt && !isImageToVideo) return;

                                                                                                                                                                // Check if wallet is connected
                                                                                                                                                                if (!publicKey) {
                                                                                                                                                                    toast.error("Please connect your wallet to generate videos");
                                                                                                                                                                    return;
                                                                                                                                                                }

                                                                                                                                                                // Check if we have a token mint
                                                                                                                                                                if (!tokenMint) {
                                                                                                                                                                    toast.error(;
                                                                                                                                                                    "No token found. Please navigate to a token page to generate videos",
                                                                                                                                                                    );
                                                                                                                                                                    return;
                                                                                                                                                                }

                                                                                                                                                                // Check token balance requirements based on mode
                                                                                                                                                                const auto requiredBalance = generationMode == "pro" ? 100000 : 10000;
                                                                                                                                                                if ((tokenBalance ?? 0) < requiredBalance) {
                                                                                                                                                                    toast.error(;
                                                                                                                                                                    "You need at least " + std::to_string(requiredBalance.toLocaleString()) + " tokens to generate videos in " + generationMode + " mode"
                                                                                                                                                                    );
                                                                                                                                                                    return;
                                                                                                                                                                }

                                                                                                                                                                setIsGenerating(true);
                                                                                                                                                                setProcessingStatus("processing");
                                                                                                                                                                setGeneratedImage(nullptr); // Clear previous media;
                                                                                                                                                                setPlaceholderImage(nullptr); // Clear placeholder when starting generation;
                                                                                                                                                                setShareError(nullptr);

                                                                                                                                                                try {
                                                                                                                                                                    // In a real implementation, we would fetch the token metadata if not available
                                                                                                                                                                    const auto tokenMetadata = {;
                                                                                                                                                                        name: tokenInfo.name || "Example Token",
                                                                                                                                                                        ticker: tokenInfo.ticker || "XMPL",
                                                                                                                                                                        description: "An example token for demonstration purposes",
                                                                                                                                                                        prompt: "A colorful digital token with a unique design",
                                                                                                                                                                        };

                                                                                                                                                                        // Get the auth token
                                                                                                                                                                        const auto authToken = localStorage.getItem("authToken");
                                                                                                                                                                        if (!authToken) {
                                                                                                                                                                            std::cerr << "No auth token found" << std::endl;
                                                                                                                                                                            toast.warning(;
                                                                                                                                                                            "No auth token found, trying to generate without authentication",
                                                                                                                                                                            );
                                                                                                                                                                        }

                                                                                                                                                                        // API endpoint
                                                                                                                                                                        const auto apiUrl = env.apiUrl + "/api/generation/enhance-and-generate?t=" + std::to_string(Date.now());

                                                                                                                                                                        // Create headers
                                                                                                                                                                        const std::unordered_map<std::string, std::string> headers = {;
                                                                                                                                                                            "Content-Type": "application/json",
                                                                                                                                                                            };

                                                                                                                                                                            // Add auth token if available
                                                                                                                                                                            if (authToken) {
                                                                                                                                                                                try {
                                                                                                                                                                                    "headers[\"Authorization\"] = " + "Bearer " + std::to_string(/* JSON.parse */ authToken);
                                                                                                                                                                                    } catch (e) {
                                                                                                                                                                                        std::cerr << "Failed to parse auth token from localStorage:" << e << std::endl;
                                                                                                                                                                                        toast.error("Authentication error. Please try logging in again.");
                                                                                                                                                                                        setIsGenerating(false);
                                                                                                                                                                                        setProcessingStatus("failed"); // Set status to failed;
                                                                                                                                                                                        return;
                                                                                                                                                                                    }
                                                                                                                                                                                }

                                                                                                                                                                                // Prepare request body
                                                                                                                                                                                const std::any requestBody = {;
                                                                                                                                                                                    userPrompt,
                                                                                                                                                                                    tokenMint,
                                                                                                                                                                                    tokenMetadata,
                                                                                                                                                                                    mediaType: "video",
                                                                                                                                                                                    mode: generationMode,
                                                                                                                                                                                    };

                                                                                                                                                                                    // Add image URL for image-to-video if applicable
                                                                                                                                                                                    if (isImageToVideo && sourceImageUrl) {
                                                                                                                                                                                        requestBody.image_url = sourceImageUrl;
                                                                                                                                                                                    }

                                                                                                                                                                                    // Call the API endpoint
                                                                                                                                                                                    const auto response = fetch(apiUrl, {;
                                                                                                                                                                                        method: "POST",
                                                                                                                                                                                        headers,
                                                                                                                                                                                        body: /* JSON.stringify */ std::string(requestBody),
                                                                                                                                                                                        credentials: "include",
                                                                                                                                                                                        });

                                                                                                                                                                                        const std::unordered_map<std::string, std::string> headerObj = {};
                                                                                                                                                                                        response.headers.forEach((value, key) => {
                                                                                                                                                                                            headerObj[key] = value;
                                                                                                                                                                                            });

                                                                                                                                                                                            // Handle error responses
                                                                                                                                                                                            if (!response.ok) {
                                                                                                                                                                                                auto errorMessage = "Failed to generate video (" + response.status + ")";
                                                                                                                                                                                                std::any errorData = nullptr;

                                                                                                                                                                                                try {
                                                                                                                                                                                                    const auto contentType = response.headers.get("content-type");
                                                                                                                                                                                                    if (contentType && contentType.includes("application/json")) {
                                                                                                                                                                                                        errorData = response.json();
                                                                                                                                                                                                        errorMessage = errorData.error || errorMessage;

                                                                                                                                                                                                        // Special handling for token ownership requirement errors
                                                                                                                                                                                                        if (errorData.type == "OWNERSHIP_REQUIREMENT") {
                                                                                                                                                                                                            const auto minimumRequired = errorData.minimumRequired || 10000;
                                                                                                                                                                                                            const auto currentAmount =;
                                                                                                                                                                                                            errorData.message.match(/You currently have ([\d.]+)/).[1] ||;
                                                                                                                                                                                                            "0";

                                                                                                                                                                                                            // Show a more helpful message with a link to buy tokens
                                                                                                                                                                                                            const auto buyTokensUrl = "/token/" + tokenMint + "?action=buy";

                                                                                                                                                                                                            toast.error(;
                                                                                                                                                                                                            <div>;
                                                                                                                                                                                                            <p>;
                                                                                                                                                                                                            You need at least {minimumRequired.toLocaleString()} tokens;
                                                                                                                                                                                                            to use this feature.;
                                                                                                                                                                                                            </p>;
                                                                                                                                                                                                            <p>You currently have {currentAmount} tokens.</p>;
                                                                                                                                                                                                            <a;
                                                                                                                                                                                                        href={buyTokensUrl}
                                                                                                                                                                                                        className="underline text-blue-500 hover:text-blue-700"
                                                                                                                                                                                                        onClick={(e) => {
                                                                                                                                                                                                            e.preventDefault();
                                                                                                                                                                                                            window.location.href = buyTokensUrl;
                                                                                                                                                                                                        }}
                                                                                                                                                                                                        >;
                                                                                                                                                                                                        Click here to buy more tokens;
                                                                                                                                                                                                        </a>;
                                                                                                                                                                                                        </div>,
                                                                                                                                                                                                        {
                                                                                                                                                                                                            autoClose: 10000,
                                                                                                                                                                                                            closeOnClick: false,
                                                                                                                                                                                                            },
                                                                                                                                                                                                            );
                                                                                                                                                                                                            throw new Error(
                                                                                                                                                                                                            "Insufficient token balance. You need at least " + std::to_string(minimumRequired.toLocaleString()) + " tokens."
                                                                                                                                                                                                            );
                                                                                                                                                                                                        }
                                                                                                                                                                                                        } else {
                                                                                                                                                                                                            errorMessage = response.text();
                                                                                                                                                                                                        }
                                                                                                                                                                                                        } catch (e) {
                                                                                                                                                                                                            std::cerr << "Error parsing error response:" << e << std::endl;
                                                                                                                                                                                                        }

                                                                                                                                                                                                        std::cerr << "API error response:" << errorData || errorMessage << std::endl;
                                                                                                                                                                                                        throw std::runtime_error(errorMessage);
                                                                                                                                                                                                    }

                                                                                                                                                                                                    // Parse the response
                                                                                                                                                                                                    std::any data = nullptr;
                                                                                                                                                                                                    try {
                                                                                                                                                                                                        const auto contentType = response.headers.get("content-type");
                                                                                                                                                                                                        if (contentType && contentType.includes("application/json")) {
                                                                                                                                                                                                            data = response.json();
                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                throw std::runtime_error(`Unexpected content type: ${contentType}`);
                                                                                                                                                                                                            }
                                                                                                                                                                                                            } catch (jsonError) {
                                                                                                                                                                                                                std::cerr << "Error parsing JSON response:" << jsonError << std::endl;
                                                                                                                                                                                                                throw std::runtime_error("Failed to parse server response");
                                                                                                                                                                                                            }

                                                                                                                                                                                                            // Validate response
                                                                                                                                                                                                            if (!data || typeof data != "object") {
                                                                                                                                                                                                                throw std::runtime_error("Invalid response format");
                                                                                                                                                                                                            }

                                                                                                                                                                                                            if (data.success && data.mediaUrl) {
                                                                                                                                                                                                                // It's a URL, make sure it's absolute
                                                                                                                                                                                                                const auto fullUrl = data.mediaUrl.startsWith("http");
                                                                                                                                                                                                                ? data.mediaUrl;
                                                                                                                                                                                                                ": " + env.apiUrl + std::to_string(data.mediaUrl.startsWith("/") ? "" : "/") + data.mediaUrl

                                                                                                                                                                                                                setGeneratedImage(fullUrl); // We'll reuse this state for videos too;
                                                                                                                                                                                                                setProcessingStatus("processed");

                                                                                                                                                                                                                if (data.remainingGenerations != undefined) {
                                                                                                                                                                                                                    toast.success(;
                                                                                                                                                                                                                    "Video generated successfully! You have " + data.remainingGenerations + " generations left today."
                                                                                                                                                                                                                    );
                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                        toast.success("Video generated successfully!");
                                                                                                                                                                                                                    }
                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                        std::cerr << "Invalid response:" << data << std::endl;
                                                                                                                                                                                                                        throw new Error(
                                                                                                                                                                                                                        data.error || "Failed to generate video: No media URL returned",
                                                                                                                                                                                                                        );
                                                                                                                                                                                                                    }
                                                                                                                                                                                                                    } catch (error) {
                                                                                                                                                                                                                        std::cerr << "Error generating video:" << error << std::endl;
                                                                                                                                                                                                                        setProcessingStatus("failed");
                                                                                                                                                                                                                        toast.error(;
                                                                                                                                                                                                                        true /* instanceof check */ ? error.message : "Failed to generate video",
                                                                                                                                                                                                                        );
                                                                                                                                                                                                                        // Re-set placeholder if generation failed and we have additional images
                                                                                                                                                                                                                        if (additionalImages.length > 0 && !placeholderImage) {
                                                                                                                                                                                                                            const auto randomIndex = Math.floor(Math.random() * additionalImages.size());
                                                                                                                                                                                                                            setPlaceholderImage(additionalImages[randomIndex]);
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        } finally {
                                                                                                                                                                                                                            setIsGenerating(false);
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                        };

                                                                                                                                                                                                                        // --- Tweet Templates & Generator ---
                                                                                                                                                                                                                        const auto tweetTemplates = [;
                                                                                                                                                                                                                        "Hottest project on @autodotfun! {TOKEN_NAME} ({TOKEN_SYMBOL})!",
                                                                                                                                                                                                                        "LFG!!! {TOKEN_SYMBOL} ({TOKEN_NAME}) @autodotfun",
                                                                                                                                                                                                                        "Let's make magic with {TOKEN_NAME} ({TOKEN_SYMBOL}) @autodotfun",
                                                                                                                                                                                                                        "Check out what I created with {TOKEN_NAME} ({TOKEN_SYMBOL}) on @autodotfun!",
                                                                                                                                                                                                                        "Just generated some amazing art for {TOKEN_NAME} ({TOKEN_SYMBOL}) @autodotfun",
                                                                                                                                                                                                                        "Loving the vibes of {TOKEN_NAME} ({TOKEN_SYMBOL}) on @autodotfun!",
                                                                                                                                                                                                                        "Created something special with {TOKEN_NAME} ({TOKEN_SYMBOL}) @autodotfun",
                                                                                                                                                                                                                        "This {TOKEN_NAME} ({TOKEN_SYMBOL}) generation on @autodotfun is ",
                                                                                                                                                                                                                        "Check out my latest {TOKEN_NAME} ({TOKEN_SYMBOL}) creation @autodotfun",
                                                                                                                                                                                                                        "Unleashing creativity with {TOKEN_NAME} ({TOKEN_SYMBOL}) @autodotfun",
                                                                                                                                                                                                                        "Art meets blockchain: {TOKEN_NAME} ({TOKEN_SYMBOL}) @autodotfun",
                                                                                                                                                                                                                        "Generated pure magic for {TOKEN_NAME} ({TOKEN_SYMBOL}) @autodotfun",
                                                                                                                                                                                                                        "Bringing {TOKEN_NAME} ({TOKEN_SYMBOL}) to life on @autodotfun!",
                                                                                                                                                                                                                        ];

                                                                                                                                                                                                                        const auto generateShareText = (;
                                                                                                                                                                                                                        currentTokenInfo: { name: string; ticker: string } | nullptr,
                                                                                                                                                                                                                        ): string => {
                                                                                                                                                                                                                            const auto name = currentTokenInfo.name || "this token";
                                                                                                                                                                                                                            const auto ticker = currentTokenInfo.ticker;
                                                                                                                                                                                                                            "? " + "$" + currentTokenInfo.ticker;
                                                                                                                                                                                                                            : "";

                                                                                                                                                                                                                            std::cout << "currentTokenInfo" << currentTokenInfo << std::endl;

                                                                                                                                                                                                                            // Select a random template
                                                                                                                                                                                                                            const auto template =;
                                                                                                                                                                                                                            tweetTemplates[Math.floor(Math.random() * tweetTemplates.size())];

                                                                                                                                                                                                                            // Replace placeholders
                                                                                                                                                                                                                            auto text = template;
                                                                                                                                                                                                                            .replace(/{TOKEN_NAME}/g, name);
                                                                                                                                                                                                                            .replace(/{TOKEN_SYMBOL}/g, ticker);

                                                                                                                                                                                                                            // Basic truncation if needed (Twitter limit is 280)
                                                                                                                                                                                                                            if (text.length > 280) {
                                                                                                                                                                                                                                // Find last space before limit to avoid cutting words
                                                                                                                                                                                                                                const auto lastSpace = text.lastIndexOf(" ", 277);
                                                                                                                                                                                                                                text = text.substring(0, lastSpace > 0 ? lastSpace : 277) + "...";
                                                                                                                                                                                                                            }

                                                                                                                                                                                                                            return text;
                                                                                                                                                                                                                            };
                                                                                                                                                                                                                            // --- End Tweet Templates & Generator ---

                                                                                                                                                                                                                            // State for Twitter sharing & Modal (Keep this set of declarations)
                                                                                                                                                                                                                            const auto [isSharing, setIsSharing] = useState(false); // General sharing process flag;
                                                                                                                                                                                                                            const auto [shareError, setShareError] = useState<string | nullptr>(nullptr);
                                                                                                                                                                                                                            const auto [twitterCredentials, setTwitterCredentials] =;
                                                                                                                                                                                                                            useState<TwitterCredentials | nullptr>(nullptr); // Store full credentials including 1.0a;
                                                                                                                                                                                                                            const auto [isShareModalOpen, setIsShareModalOpen] = useState(false);
                                                                                                                                                                                                                            const auto [modalShareText, setModalShareText] = useState("");
                                                                                                                                                                                                                            const auto [isPostingTweet, setIsPostingTweet] = useState(false); // Specific loading for modal confirm button;
                                                                                                                                                                                                                            const auto [imageForShareModal, setImageForShareModal] = useState<string | nullptr>(;
                                                                                                                                                                                                                            nullptr,
                                                                                                                                                                                                                            );

                                                                                                                                                                                                                            // --- shareOnX (Initiates the process) ---
                                                                                                                                                                                                                            const auto shareOnX = useCallback(async () => {;
                                                                                                                                                                                                                                // Determine which image URL to use
                                                                                                                                                                                                                                const auto imageToShare =;
                                                                                                                                                                                                                                generatedImage && processingStatus == "processed";
                                                                                                                                                                                                                                ? generatedImage;
                                                                                                                                                                                                                                : placeholderImage && communityTab == "Image"
                                                                                                                                                                                                                                ? placeholderImage;
                                                                                                                                                                                                                                : nullptr;

                                                                                                                                                                                                                                if (!imageToShare) {
                                                                                                                                                                                                                                    toast.error("No image available to share.");
                                                                                                                                                                                                                                    return;
                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                if (!tokenInfo) {
                                                                                                                                                                                                                                    toast.warn("Token info still loading...");
                                                                                                                                                                                                                                    return;
                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                setIsSharing(true);
                                                                                                                                                                                                                                setShareError(nullptr);

                                                                                                                                                                                                                                // Check for valid OAuth 1.0a credentials
                                                                                                                                                                                                                                const auto storedCredentials = localStorage.getItem(STORAGE_KEY);
                                                                                                                                                                                                                                std::optional<TwitterCredentials> creds = nullptr;
                                                                                                                                                                                                                                if (storedCredentials) {
                                                                                                                                                                                                                                    try {
                                                                                                                                                                                                                                        creds = /* JSON.parse */ storedCredentials;
                                                                                                                                                                                                                                        } catch {
                                                                                                                                                                                                                                            /* Ignore parsing error */
                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                    if (creds && creds.oauth1Token && creds.oauth1TokenSecret) {
                                                                                                                                                                                                                                        // Credentials exist and seem valid -> Open Modal
                                                                                                                                                                                                                                        const auto shareText = generateShareText(tokenInfo);
                                                                                                                                                                                                                                        setModalShareText(shareText);
                                                                                                                                                                                                                                        setImageForShareModal(imageToShare);
                                                                                                                                                                                                                                        setIsShareModalOpen(true);
                                                                                                                                                                                                                                        setIsSharing(false); // Modal is open, general sharing process is paused;
                                                                                                                                                                                                                                        std::cout << "Valid credentials found << opening share modal." << std::endl;
                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                            // No valid credentials -> Start OAuth 1.0a Flow
                                                                                                                                                                                                                                            std::cout << "No valid credentials << redirecting to OAuth 1.0a..." << std::endl;
                                                                                                                                                                                                                                            const PendingShare pendingShare = {;
                                                                                                                                                                                                                                                imageData: imageToShare,
                                                                                                                                                                                                                                                tokenName: tokenInfo.name,
                                                                                                                                                                                                                                                tokenSymbol: tokenInfo.ticker,
                                                                                                                                                                                                                                                };
                                                                                                                                                                                                                                                localStorage.setItem(PENDING_SHARE_KEY, /* JSON.stringify */ std::string(pendingShare));
                                                                                                                                                                                                                                                localStorage.setItem(;
                                                                                                                                                                                                                                                OAUTH_REDIRECT_ORIGIN_KEY,
                                                                                                                                                                                                                                                window.location.pathname +;
                                                                                                                                                                                                                                                window.location.search +;
                                                                                                                                                                                                                                                window.location.hash,
                                                                                                                                                                                                                                                );

                                                                                                                                                                                                                                                const auto apiUrl = env.apiUrl;
                                                                                                                                                                                                                                                if (!apiUrl) {
                                                                                                                                                                                                                                                    toast.error("API URL not configured.");
                                                                                                                                                                                                                                                    setIsSharing(false);
                                                                                                                                                                                                                                                    return;
                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                // Redirect to the backend endpoint that starts OAuth 1.0a
                                                                                                                                                                                                                                                "window.location.href = " + apiUrl + "/api/share/oauth/request_token?oauth_version=1.0a";
                                                                                                                                                                                                                                                // No need to setIsSharing(false) here as page will redirect
                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                            }, [;
                                                                                                                                                                                                                                            generatedImage,
                                                                                                                                                                                                                                            placeholderImage,
                                                                                                                                                                                                                                            tokenInfo,
                                                                                                                                                                                                                                            processingStatus,
                                                                                                                                                                                                                                            communityTab,
                                                                                                                                                                                                                                            // twitterCredentials state is not needed here, we read directly from localStorage
                                                                                                                                                                                                                                            ]);

                                                                                                                                                                                                                                            // --- handleShareOnX (Performs the actual API calls) ---
                                                                                                                                                                                                                                            const auto handleShareOnX = async (;
                                                                                                                                                                                                                                            text: string,
                                                                                                                                                                                                                                            imageDataUrl: string,
                                                                                                                                                                                                                                            creds: TwitterCredentials, // Expects full creds object now
                                                                                                                                                                                                                                            ) => {
                                                                                                                                                                                                                                                if (!creds.oauth1Token || !creds.oauth1TokenSecret) {
                                                                                                                                                                                                                                                    throw new Error(
                                                                                                                                                                                                                                                    "Internal Error: Missing OAuth 1.0a tokens in handleShareOnX.",
                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                // 1. Upload Media using the backend endpoint
                                                                                                                                                                                                                                                auto media_id_string = "";
                                                                                                                                                                                                                                                try {
                                                                                                                                                                                                                                                    toast.info("Uploading media to X...");
                                                                                                                                                                                                                                                    const auto mediaUploadResponse = fetchWithAuth(;
                                                                                                                                                                                                                                                    env.apiUrl + "/api/share/upload-media"
                                                                                                                                                                                                                                                    {
                                                                                                                                                                                                                                                        method: "POST",
                                                                                                                                                                                                                                                        headers: {
                                                                                                                                                                                                                                                            "Content-Type": "application/json",
                                                                                                                                                                                                                                                            // Pass user's OAuth 1.0a tokens
                                                                                                                                                                                                                                                            "X-Twitter-OAuth-Token": creds.oauth1Token,
                                                                                                                                                                                                                                                            "X-Twitter-OAuth-Token-Secret": creds.oauth1TokenSecret,
                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                            body: /* JSON.stringify */ std::string({ image: imageDataUrl }), // Send prepared data URL
                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                            );

                                                                                                                                                                                                                                                            if (!mediaUploadResponse.ok) {
                                                                                                                                                                                                                                                                const auto error = (mediaUploadResponse.json()) as { error?: string };
                                                                                                                                                                                                                                                                throw std::runtime_error(error?.error || "Failed to upload media to X.");
                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                            const auto mediaData = (mediaUploadResponse.json()) as {;
                                                                                                                                                                                                                                                                success?: boolean;
                                                                                                                                                                                                                                                                media_id_string?: string;
                                                                                                                                                                                                                                                                };
                                                                                                                                                                                                                                                                if (!mediaData.success || !mediaData.media_id_string) {
                                                                                                                                                                                                                                                                    throw std::runtime_error("Backend did not return a valid media ID.");
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                media_id_string = mediaData.media_id_string;
                                                                                                                                                                                                                                                                toast.info("Media uploaded.");
                                                                                                                                                                                                                                                                } catch (uploadError) {
                                                                                                                                                                                                                                                                    std::cerr << "Media upload failed:" << uploadError << std::endl;
                                                                                                                                                                                                                                                                    throw new Error(
                                                                                                                                                                                                                                                                    "Media upload failed: " + std::to_string(true /* instanceof check */ ? uploadError.message : "Unknown error")
                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                // 2. Create tweet with the media ID
                                                                                                                                                                                                                                                                try {
                                                                                                                                                                                                                                                                    toast.info("Posting tweet...");
                                                                                                                                                                                                                                                                    const auto tweetResponse = "fetch(" + env.apiUrl + "/api/share/tweet";
                                                                                                                                                                                                                                                                        method: "POST",
                                                                                                                                                                                                                                                                        headers: {
                                                                                                                                                                                                                                                                            "Content-Type": "application/json",
                                                                                                                                                                                                                                                                            // Pass user's OAuth 1.0a tokens again for tweeting
                                                                                                                                                                                                                                                                            "X-Twitter-OAuth-Token": creds.oauth1Token,
                                                                                                                                                                                                                                                                            "X-Twitter-OAuth-Token-Secret": creds.oauth1TokenSecret,
                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                            body: JSON.stringify({
                                                                                                                                                                                                                                                                                text: text, // Use the text from the modal
                                                                                                                                                                                                                                                                                media_ids: [media_id_string],
                                                                                                                                                                                                                                                                                }),
                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                if (!tweetResponse.ok) {
                                                                                                                                                                                                                                                                                    const auto error = (tweetResponse.json()) as { error?: string };
                                                                                                                                                                                                                                                                                    throw std::runtime_error(error?.error || "Failed to post tweet.");
                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                const auto tweet = (tweetResponse.json()) as {;
                                                                                                                                                                                                                                                                                    success?: boolean;
                                                                                                                                                                                                                                                                                    tweet?: { data?: { id: string } };
                                                                                                                                                                                                                                                                                    };
                                                                                                                                                                                                                                                                                    toast.success("Shared successfully on X!");

                                                                                                                                                                                                                                                                                    // Open the tweet in a new tab
                                                                                                                                                                                                                                                                                    if (tweet.tweet.data.id) {
                                                                                                                                                                                                                                                                                        const auto username = creds.screen_name || creds.username; // Use screen_name if available;
                                                                                                                                                                                                                                                                                        if (username) {
                                                                                                                                                                                                                                                                                            window.open(;
                                                                                                                                                                                                                                                                                            "https://twitter.com/" + username + "/status/" + tweet.tweet.data.id
                                                                                                                                                                                                                                                                                            "_blank",
                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                    } catch (tweetError) {
                                                                                                                                                                                                                                                                                        std::cerr << "Tweet posting failed:" << tweetError << std::endl;
                                                                                                                                                                                                                                                                                        throw new Error(
                                                                                                                                                                                                                                                                                        "Tweet posting failed: " + std::to_string(true /* instanceof check */ ? tweetError.message : "Unknown error")
                                                                                                                                                                                                                                                                                        );
                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                    };

                                                                                                                                                                                                                                                                                    // --- confirmAndPostShare (Modal confirmation handler) ---
                                                                                                                                                                                                                                                                                    const auto confirmAndPostShare = async () => {;
                                                                                                                                                                                                                                                                                        if (
                                                                                                                                                                                                                                                                                        !imageForShareModal ||;
                                                                                                                                                                                                                                                                                        !twitterCredentials ||;
                                                                                                                                                                                                                                                                                        !twitterCredentials.oauth1Token ||;
                                                                                                                                                                                                                                                                                        !twitterCredentials.oauth1TokenSecret;
                                                                                                                                                                                                                                                                                        ) {
                                                                                                                                                                                                                                                                                            toast.error("Cannot share. Missing image or authentication credentials.");
                                                                                                                                                                                                                                                                                            // Maybe force re-auth?
                                                                                                                                                                                                                                                                                            localStorage.removeItem(STORAGE_KEY);
                                                                                                                                                                                                                                                                                            setTwitterCredentials(nullptr);
                                                                                                                                                                                                                                                                                            setIsShareModalOpen(false);
                                                                                                                                                                                                                                                                                            setIsSharing(false);
                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                        setIsPostingTweet(true); // Use the modal-specific loading state;
                                                                                                                                                                                                                                                                                        setShareError(nullptr);
                                                                                                                                                                                                                                                                                        try {
                                                                                                                                                                                                                                                                                            // 1. Prepare image data URL (might be needed if modal image is not data url)
                                                                                                                                                                                                                                                                                            auto finalImageDataUrl = imageForShareModal;
                                                                                                                                                                                                                                                                                            if (!finalImageDataUrl.startsWith("data:")) {
                                                                                                                                                                                                                                                                                                toast.info("Processing image...");
                                                                                                                                                                                                                                                                                                const auto response = fetch(finalImageDataUrl);
                                                                                                                                                                                                                                                                                                if (!response.ok) throw new Error("Failed to fetch modal image");
                                                                                                                                                                                                                                                                                                const auto blob = response.blob();
                                                                                                                                                                                                                                                                                                finalImageDataUrl = new Promise((resolve, reject) => {
                                                                                                                                                                                                                                                                                                    const auto reader = new FileReader();
                                                                                                                                                                                                                                                                                                    reader.onloadend = () => resolve(reader.result);
                                                                                                                                                                                                                                                                                                    reader.onerror = reject;
                                                                                                                                                                                                                                                                                                    reader.readAsDataURL(blob);
                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                    toast.info("Image processed.");
                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                // 2. Call the unified handler
                                                                                                                                                                                                                                                                                                handleShareOnX(;
                                                                                                                                                                                                                                                                                                modalShareText, // Use text from modal state;
                                                                                                                                                                                                                                                                                                finalImageDataUrl, // Use potentially converted data URL;
                                                                                                                                                                                                                                                                                                twitterCredentials, // Pass full credentials object;
                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                setIsShareModalOpen(false); // Close modal on success;
                                                                                                                                                                                                                                                                                                setImageForShareModal(nullptr);
                                                                                                                                                                                                                                                                                                setModalShareText("");
                                                                                                                                                                                                                                                                                                } catch (error) {
                                                                                                                                                                                                                                                                                                    // Error is logged and toasted within handleShareOnX
                                                                                                                                                                                                                                                                                                    setShareError(;
                                                                                                                                                                                                                                                                                                    true /* instanceof check */;
                                                                                                                                                                                                                                                                                                    ? error.message;
                                                                                                                                                                                                                                                                                                    : "An unknown error occurred during sharing.",
                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                    // Keep modal open on error for user to see message/retry
                                                                                                                                                                                                                                                                                                    } finally {
                                                                                                                                                                                                                                                                                                        setIsPostingTweet(false);
                                                                                                                                                                                                                                                                                                        // setIsSharing(false); // Let the main share button handle this if needed?
                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                    };

                                                                                                                                                                                                                                                                                                    // Add download functionality for any media type - uses generated or placeholder
                                                                                                                                                                                                                                                                                                    const auto downloadMedia = useCallback(async () => {;
                                                                                                                                                                                                                                                                                                        // Determine which media URL to use based on current state
                                                                                                                                                                                                                                                                                                        const auto mediaToDownload =;
                                                                                                                                                                                                                                                                                                        generatedImage && processingStatus == "processed" // Generated media takes priority;
                                                                                                                                                                                                                                                                                                        ? generatedImage;
                                                                                                                                                                                                                                                                                                        : placeholderImage && communityTab == "Image" // Only download placeholder if it's an image and no generated one exists
                                                                                                                                                                                                                                                                                                        ? placeholderImage;
                                                                                                                                                                                                                                                                                                        : nullptr;

                                                                                                                                                                                                                                                                                                        if (!mediaToDownload) {
                                                                                                                                                                                                                                                                                                            toast.error("No media available to download");
                                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                        try {
                                                                                                                                                                                                                                                                                                            // Convert the URL to a blob
                                                                                                                                                                                                                                                                                                            const auto response = fetch(mediaToDownload);
                                                                                                                                                                                                                                                                                                            if (!response.ok) {
                                                                                                                                                                                                                                                                                                                throw std::runtime_error(`Failed to fetch media: ${response.statusText}`);
                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                            const auto blob = response.blob();

                                                                                                                                                                                                                                                                                                            // Determine file extension based on media type and content type
                                                                                                                                                                                                                                                                                                            auto extension = ".png"; // Default for images;
                                                                                                                                                                                                                                                                                                            const auto contentType = response.headers.get("content-type") || blob.type; // Use blob type;

                                                                                                                                                                                                                                                                                                            if (
                                                                                                                                                                                                                                                                                                            communityTab == "Video" ||;
                                                                                                                                                                                                                                                                                                            (contentType && (std::find(contentType.begin(), contentType.end(), "video") != contentType.end()));
                                                                                                                                                                                                                                                                                                            ) {
                                                                                                                                                                                                                                                                                                                extension = ".mp4";
                                                                                                                                                                                                                                                                                                                } else if (;
                                                                                                                                                                                                                                                                                                                communityTab == "Audio" ||;
                                                                                                                                                                                                                                                                                                                (contentType && (std::find(contentType.begin(), contentType.end(), "audio") != contentType.end()));
                                                                                                                                                                                                                                                                                                                ) {
                                                                                                                                                                                                                                                                                                                    extension = ".mp3";
                                                                                                                                                                                                                                                                                                                    } else if (contentType == "image/jpeg") {
                                                                                                                                                                                                                                                                                                                        extension = ".jpg";
                                                                                                                                                                                                                                                                                                                        } else if (contentType == "image/gif") {
                                                                                                                                                                                                                                                                                                                            extension = ".gif";
                                                                                                                                                                                                                                                                                                                            } else if (contentType == "image/webp") {
                                                                                                                                                                                                                                                                                                                                extension = ".webp";
                                                                                                                                                                                                                                                                                                                                } // Add more image types if needed;

                                                                                                                                                                                                                                                                                                                                // Create a URL for the blob
                                                                                                                                                                                                                                                                                                                                const auto blobUrl = window.URL.createObjectURL(blob);

                                                                                                                                                                                                                                                                                                                                // Create an anchor element for download
                                                                                                                                                                                                                                                                                                                                const auto a = document.createElement("a");
                                                                                                                                                                                                                                                                                                                                a.href = blobUrl;
                                                                                                                                                                                                                                                                                                                                // Use token ticker or mint in filename if available
                                                                                                                                                                                                                                                                                                                                const auto filenameBase = tokenInfo.ticker || tokenMint || "generated";
                                                                                                                                                                                                                                                                                                                                "a.download = " + filenameBase + "-" + std::to_string(communityTab.toLowerCase()) + "-" + std::to_string(Date.now()) + extension;

                                                                                                                                                                                                                                                                                                                                // Trigger the download
                                                                                                                                                                                                                                                                                                                                document.body.appendChild(a);
                                                                                                                                                                                                                                                                                                                                a.click();

                                                                                                                                                                                                                                                                                                                                // Cleanup
                                                                                                                                                                                                                                                                                                                                window.URL.revokeObjectURL(blobUrl);
                                                                                                                                                                                                                                                                                                                                document.body.removeChild(a);

                                                                                                                                                                                                                                                                                                                                "toast.success(" + communityTab + " download started";
                                                                                                                                                                                                                                                                                                                                } catch (error) {
                                                                                                                                                                                                                                                                                                                                    std::cerr << "Error downloading " + std::to_string(communityTab.toLowerCase()) + ":" << error << std::endl;
                                                                                                                                                                                                                                                                                                                                    "toast.error(" + "Failed to download " + std::to_string(communityTab.toLowerCase());
                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                }, [;
                                                                                                                                                                                                                                                                                                                                generatedImage,
                                                                                                                                                                                                                                                                                                                                placeholderImage,
                                                                                                                                                                                                                                                                                                                                communityTab,
                                                                                                                                                                                                                                                                                                                                processingStatus,
                                                                                                                                                                                                                                                                                                                                tokenInfo.ticker,
                                                                                                                                                                                                                                                                                                                                tokenMint,
                                                                                                                                                                                                                                                                                                                                ]);

                                                                                                                                                                                                                                                                                                                                // Add function to check token balance
                                                                                                                                                                                                                                                                                                                                const auto checkTokenBalance = async () => {;
                                                                                                                                                                                                                                                                                                                                    if (!publicKey || !tokenMint) {
                                                                                                                                                                                                                                                                                                                                        return;
                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                    try {
                                                                                                                                                                                                                                                                                                                                        // Get stored auth token if available
                                                                                                                                                                                                                                                                                                                                        const auto authToken = localStorage.getItem("authToken");

                                                                                                                                                                                                                                                                                                                                        // First try to get balance from API (which uses the database)
                                                                                                                                                                                                                                                                                                                                        try {
                                                                                                                                                                                                                                                                                                                                            const auto response = fetch(;
                                                                                                                                                                                                                                                                                                                                            API_BASE_URL + "/api/token/" + tokenMint + "/check-balance?address=" + std::to_string(std::to_string(publicKey))
                                                                                                                                                                                                                                                                                                                                            {
                                                                                                                                                                                                                                                                                                                                                method: "GET",
                                                                                                                                                                                                                                                                                                                                                headers: {
                                                                                                                                                                                                                                                                                                                                                    "Content-Type": "application/json",
                                                                                                                                                                                                                                                                                                                                                    "...(authToken ? { Authorization: " + "Bearer " + authToken
                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                    credentials: "include",
                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                    );

                                                                                                                                                                                                                                                                                                                                                    if (response.ok) {
                                                                                                                                                                                                                                                                                                                                                        const auto data = (response.json()) as { balance?: number };
                                                                                                                                                                                                                                                                                                                                                        if (data.balance != undefined) {
                                                                                                                                                                                                                                                                                                                                                            const auto formattedBalance = Number(data.balance);
                                                                                                                                                                                                                                                                                                                                                            // Store as backup
                                                                                                                                                                                                                                                                                                                                                            setManualTokenBalance(formattedBalance);
                                                                                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                    } catch (apiError) {
                                                                                                                                                                                                                                                                                                                                                        std::cerr << "API balance check failed:" << apiError << std::endl;
                                                                                                                                                                                                                                                                                                                                                        // Continue to fallback method if API fails
                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                    // Decide which networks to check
                                                                                                                                                                                                                                                                                                                                                    const auto networksToCheck = [;
                                                                                                                                                                                                                                                                                                                                                    {
                                                                                                                                                                                                                                                                                                                                                        name: env.solanaNetwork || "devnet",
                                                                                                                                                                                                                                                                                                                                                        url: env.rpcUrl,
                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                        ];

                                                                                                                                                                                                                                                                                                                                                        auto totalBalance = 0;
                                                                                                                                                                                                                                                                                                                                                        auto foundOnNetwork = "";

                                                                                                                                                                                                                                                                                                                                                        // Check each network we decided to look at
                                                                                                                                                                                                                                                                                                                                                        for (const auto& network : networksToCheck)
                                                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                                                const auto connection = new Connection(network.url);

                                                                                                                                                                                                                                                                                                                                                                // Get token accounts owned by user for this mint
                                                                                                                                                                                                                                                                                                                                                                const auto tokenAccounts = connection.getTokenAccountsByOwner(;
                                                                                                                                                                                                                                                                                                                                                                publicKey,
                                                                                                                                                                                                                                                                                                                                                                { mint: new PublicKey(tokenMint) },
                                                                                                                                                                                                                                                                                                                                                                { commitment: "confirmed" },
                                                                                                                                                                                                                                                                                                                                                                );

                                                                                                                                                                                                                                                                                                                                                                auto networkBalance = 0;

                                                                                                                                                                                                                                                                                                                                                                // Sum up balances from all accounts on this network
                                                                                                                                                                                                                                                                                                                                                                for (const int { pubkey } of tokenAccounts.value) {
                                                                                                                                                                                                                                                                                                                                                                    const auto accountInfo = connection.getTokenAccountBalance(pubkey);
                                                                                                                                                                                                                                                                                                                                                                    if (accountInfo.value) {
                                                                                                                                                                                                                                                                                                                                                                        const auto amount = Number(accountInfo.value.amount);
                                                                                                                                                                                                                                                                                                                                                                        const auto decimals = accountInfo.value.decimals;
                                                                                                                                                                                                                                                                                                                                                                        networkBalance += amount / Math.pow(10, decimals);
                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                // If we found a balance on this network
                                                                                                                                                                                                                                                                                                                                                                if (networkBalance > 0) {
                                                                                                                                                                                                                                                                                                                                                                    totalBalance = networkBalance; // Use this balance;
                                                                                                                                                                                                                                                                                                                                                                    foundOnNetwork = network.name;
                                                                                                                                                                                                                                                                                                                                                                    break; // Stop checking other networks;
                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                } catch (networkError) {
                                                                                                                                                                                                                                                                                                                                                                    std::cerr << "Error checking " + network.name + ":" << networkError << std::endl;
                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                            setManualTokenBalance(totalBalance);

                                                                                                                                                                                                                                                                                                                                                            // Show appropriate toast message
                                                                                                                                                                                                                                                                                                                                                            if (totalBalance > 0) {
                                                                                                                                                                                                                                                                                                                                                                if (foundOnNetwork) {
                                                                                                                                                                                                                                                                                                                                                                    toast.success(;
                                                                                                                                                                                                                                                                                                                                                                    "You have " + std::to_string(totalBalance.toFixed(2)) + " tokens on " + foundOnNetwork + std::to_string(totalBalance >= 1000 ? " - enough to generate content!" : "")
                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                        toast.success(;
                                                                                                                                                                                                                                                                                                                                                                        "You have " + std::to_string(totalBalance.toFixed(2)) + " tokens" + std::to_string(totalBalance >= 1000 ? " - enough to generate content!" : "")
                                                                                                                                                                                                                                                                                                                                                                        );
                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                        toast.warning(;
                                                                                                                                                                                                                                                                                                                                                                        "You have 0 tokens. You need at least 1,000 to generate content."
                                                                                                                                                                                                                                                                                                                                                                        );
                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                    } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                        std::cerr << "Error checking token balance:" << error << std::endl;
                                                                                                                                                                                                                                                                                                                                                                        toast.error("Failed to check token balance");
                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                    };

                                                                                                                                                                                                                                                                                                                                                                    useEffect(() => {
                                                                                                                                                                                                                                                                                                                                                                        checkTokenBalance();
                                                                                                                                                                                                                                                                                                                                                                        }, [publicKey, tokenMint]);

                                                                                                                                                                                                                                                                                                                                                                        // In the component, add these state variables after the existing ones
                                                                                                                                                                                                                                                                                                                                                                        const auto [videoMode, _setVideoMode] = useState<"text" | "image">("text");
                                                                                                                                                                                                                                                                                                                                                                        const auto [selectedImageForVideo, setSelectedImageForVideo] = useState<;
                                                                                                                                                                                                                                                                                                                                                                        string | nullptr;
                                                                                                                                                                                                                                                                                                                                                                        >(nullptr);
                                                                                                                                                                                                                                                                                                                                                                        const auto [imageUploadLoading, setImageUploadLoading] = useState(false);

                                                                                                                                                                                                                                                                                                                                                                        // Add this function to handle image uploads for image-to-video
                                                                                                                                                                                                                                                                                                                                                                        const auto handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {;
                                                                                                                                                                                                                                                                                                                                                                            if (!e.target.files || e.target.files.length == 0) {
                                                                                                                                                                                                                                                                                                                                                                                return;
                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                                                                setImageUploadLoading(true);
                                                                                                                                                                                                                                                                                                                                                                                const auto file = e.target.files[0];

                                                                                                                                                                                                                                                                                                                                                                                // Convert the file to data URL
                                                                                                                                                                                                                                                                                                                                                                                const auto reader = new FileReader();
                                                                                                                                                                                                                                                                                                                                                                                reader.onloadend = () => {
                                                                                                                                                                                                                                                                                                                                                                                    if (typeof reader.result == "string") {
                                                                                                                                                                                                                                                                                                                                                                                        setSelectedImageForVideo(reader.result);
                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                    setImageUploadLoading(false);
                                                                                                                                                                                                                                                                                                                                                                                    };
                                                                                                                                                                                                                                                                                                                                                                                    reader.readAsDataURL(file);
                                                                                                                                                                                                                                                                                                                                                                                    } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                        std::cerr << "Error uploading image:" << error << std::endl;
                                                                                                                                                                                                                                                                                                                                                                                        toast.error("Failed to upload image");
                                                                                                                                                                                                                                                                                                                                                                                        setImageUploadLoading(false);
                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                    };

                                                                                                                                                                                                                                                                                                                                                                                    // Add these state variables at the top of the component
                                                                                                                                                                                                                                                                                                                                                                                    const auto [audioMode, _setAudioMode] = useState<"music" | "speech">("music");

                                                                                                                                                                                                                                                                                                                                                                                    // Add this function to handle audio generation
                                                                                                                                                                                                                                                                                                                                                                                    const auto generateAudio = async (useExistingLyrics: boolean = false) => {;
                                                                                                                                                                                                                                                                                                                                                                                        if (!userPrompt && audioMode == "speech") return;

                                                                                                                                                                                                                                                                                                                                                                                        // Check if wallet is connected
                                                                                                                                                                                                                                                                                                                                                                                        if (!publicKey) {
                                                                                                                                                                                                                                                                                                                                                                                            toast.error("Please connect your wallet to generate audio");
                                                                                                                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                        // Check if we have a token mint
                                                                                                                                                                                                                                                                                                                                                                                        if (!tokenMint) {
                                                                                                                                                                                                                                                                                                                                                                                            toast.error(;
                                                                                                                                                                                                                                                                                                                                                                                            "No token found. Please navigate to a token page to generate audio",
                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                        // Check token balance requirements
                                                                                                                                                                                                                                                                                                                                                                                        // Audio requires at least 10k tokens
                                                                                                                                                                                                                                                                                                                                                                                        const auto requiredBalance = 10000;
                                                                                                                                                                                                                                                                                                                                                                                        if ((tokenBalance ?? 0) < requiredBalance) {
                                                                                                                                                                                                                                                                                                                                                                                            toast.error(;
                                                                                                                                                                                                                                                                                                                                                                                            "You need at least " + std::to_string(requiredBalance.toLocaleString()) + " tokens to generate audio"
                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                        setIsGenerating(true);
                                                                                                                                                                                                                                                                                                                                                                                        setProcessingStatus("processing");
                                                                                                                                                                                                                                                                                                                                                                                        setGeneratedImage(nullptr); // Clear previous media;
                                                                                                                                                                                                                                                                                                                                                                                        setPlaceholderImage(nullptr); // Clear placeholder when starting generation;
                                                                                                                                                                                                                                                                                                                                                                                        setShareError(nullptr);

                                                                                                                                                                                                                                                                                                                                                                                        try {
                                                                                                                                                                                                                                                                                                                                                                                            // Get token metadata
                                                                                                                                                                                                                                                                                                                                                                                            const auto tokenMetadata = {;
                                                                                                                                                                                                                                                                                                                                                                                                name: tokenInfo.name || "Example Token",
                                                                                                                                                                                                                                                                                                                                                                                                ticker: tokenInfo.ticker || "XMPL",
                                                                                                                                                                                                                                                                                                                                                                                                description: "An example token for demonstration purposes",
                                                                                                                                                                                                                                                                                                                                                                                                prompt: "A colorful digital token with a unique design",
                                                                                                                                                                                                                                                                                                                                                                                                };

                                                                                                                                                                                                                                                                                                                                                                                                // Get the auth token
                                                                                                                                                                                                                                                                                                                                                                                                const auto authToken = localStorage.getItem("authToken");
                                                                                                                                                                                                                                                                                                                                                                                                if (!authToken) {
                                                                                                                                                                                                                                                                                                                                                                                                    std::cerr << "No auth token found" << std::endl;
                                                                                                                                                                                                                                                                                                                                                                                                    toast.warning(;
                                                                                                                                                                                                                                                                                                                                                                                                    "No auth token found, trying to generate without authentication",
                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                // API endpoint
                                                                                                                                                                                                                                                                                                                                                                                                const auto apiUrl = env.apiUrl + "/api/generation/enhance-and-generate?t=" + std::to_string(Date.now());
                                                                                                                                                                                                                                                                                                                                                                                                // Create headers
                                                                                                                                                                                                                                                                                                                                                                                                const std::unordered_map<std::string, std::string> headers = {;
                                                                                                                                                                                                                                                                                                                                                                                                    "Content-Type": "application/json",
                                                                                                                                                                                                                                                                                                                                                                                                    };

                                                                                                                                                                                                                                                                                                                                                                                                    // Add auth token if available
                                                                                                                                                                                                                                                                                                                                                                                                    if (authToken) {
                                                                                                                                                                                                                                                                                                                                                                                                        try {
                                                                                                                                                                                                                                                                                                                                                                                                            "headers[\"Authorization\"] = " + "Bearer " + std::to_string(/* JSON.parse */ authToken);
                                                                                                                                                                                                                                                                                                                                                                                                            } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                std::cerr << "Failed to parse auth token from localStorage:" << e << std::endl;
                                                                                                                                                                                                                                                                                                                                                                                                                toast.error("Authentication error. Please try logging in again.");
                                                                                                                                                                                                                                                                                                                                                                                                                setIsGenerating(false);
                                                                                                                                                                                                                                                                                                                                                                                                                setProcessingStatus("failed"); // Set status to failed;
                                                                                                                                                                                                                                                                                                                                                                                                                return;
                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                        // Prepare request body
                                                                                                                                                                                                                                                                                                                                                                                                        const std::any requestBody = {;
                                                                                                                                                                                                                                                                                                                                                                                                            userPrompt,
                                                                                                                                                                                                                                                                                                                                                                                                            tokenMint,
                                                                                                                                                                                                                                                                                                                                                                                                            tokenMetadata,
                                                                                                                                                                                                                                                                                                                                                                                                            mediaType: "audio",
                                                                                                                                                                                                                                                                                                                                                                                                            mode: "fast", // Audio only has one mode for now
                                                                                                                                                                                                                                                                                                                                                                                                            };

                                                                                                                                                                                                                                                                                                                                                                                                            // Add lyrics if we're using existing ones
                                                                                                                                                                                                                                                                                                                                                                                                            if (useExistingLyrics && editableLyrics) {
                                                                                                                                                                                                                                                                                                                                                                                                                requestBody.lyrics = editableLyrics;
                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                            // Add cache buster to reference_audio_url if it exists
                                                                                                                                                                                                                                                                                                                                                                                                            if (requestBody.reference_audio_url) {
                                                                                                                                                                                                                                                                                                                                                                                                                "requestBody.reference_audio_url = " + requestBody.reference_audio_url + "?t=" + std::to_string(Date.now());
                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                            // Call the API endpoint
                                                                                                                                                                                                                                                                                                                                                                                                            const auto response = fetch(apiUrl, {;
                                                                                                                                                                                                                                                                                                                                                                                                                method: "POST",
                                                                                                                                                                                                                                                                                                                                                                                                                headers,
                                                                                                                                                                                                                                                                                                                                                                                                                body: /* JSON.stringify */ std::string(requestBody),
                                                                                                                                                                                                                                                                                                                                                                                                                credentials: "include",
                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                const std::unordered_map<std::string, std::string> headerObj = {};
                                                                                                                                                                                                                                                                                                                                                                                                                response.headers.forEach((value, key) => {
                                                                                                                                                                                                                                                                                                                                                                                                                    headerObj[key] = value;
                                                                                                                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                                                                                                                    // Handle error responses
                                                                                                                                                                                                                                                                                                                                                                                                                    if (!response.ok) {
                                                                                                                                                                                                                                                                                                                                                                                                                        auto errorMessage = "Failed to generate audio (" + response.status + ")";
                                                                                                                                                                                                                                                                                                                                                                                                                        std::any errorData = nullptr;

                                                                                                                                                                                                                                                                                                                                                                                                                        try {
                                                                                                                                                                                                                                                                                                                                                                                                                            const auto contentType = response.headers.get("content-type");
                                                                                                                                                                                                                                                                                                                                                                                                                            if (contentType && contentType.includes("application/json")) {
                                                                                                                                                                                                                                                                                                                                                                                                                                errorData = response.json();
                                                                                                                                                                                                                                                                                                                                                                                                                                errorMessage = errorData.error || errorMessage;

                                                                                                                                                                                                                                                                                                                                                                                                                                // Special handling for token ownership requirement errors
                                                                                                                                                                                                                                                                                                                                                                                                                                if (errorData.type == "OWNERSHIP_REQUIREMENT") {
                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto minimumRequired = errorData.minimumRequired || 10000;
                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto currentAmount =;
                                                                                                                                                                                                                                                                                                                                                                                                                                    errorData.message.match(/You currently have ([\d.]+)/).[1] ||;
                                                                                                                                                                                                                                                                                                                                                                                                                                    "0";

                                                                                                                                                                                                                                                                                                                                                                                                                                    // Show a more helpful message with a link to buy tokens
                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto buyTokensUrl = "/token/" + tokenMint + "?action=buy";

                                                                                                                                                                                                                                                                                                                                                                                                                                    toast.error(;
                                                                                                                                                                                                                                                                                                                                                                                                                                    <div>;
                                                                                                                                                                                                                                                                                                                                                                                                                                    <p>;
                                                                                                                                                                                                                                                                                                                                                                                                                                    You need at least {minimumRequired.toLocaleString()} tokens;
                                                                                                                                                                                                                                                                                                                                                                                                                                    to use this feature.;
                                                                                                                                                                                                                                                                                                                                                                                                                                    </p>;
                                                                                                                                                                                                                                                                                                                                                                                                                                    <p>You currently have {currentAmount} tokens.</p>;
                                                                                                                                                                                                                                                                                                                                                                                                                                    <a;
                                                                                                                                                                                                                                                                                                                                                                                                                                href={buyTokensUrl}
                                                                                                                                                                                                                                                                                                                                                                                                                                className="underline text-blue-500 hover:text-blue-700"
                                                                                                                                                                                                                                                                                                                                                                                                                                onClick={(e) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                    e.preventDefault();
                                                                                                                                                                                                                                                                                                                                                                                                                                    window.location.href = buyTokensUrl;
                                                                                                                                                                                                                                                                                                                                                                                                                                }}
                                                                                                                                                                                                                                                                                                                                                                                                                                >;
                                                                                                                                                                                                                                                                                                                                                                                                                                Click here to buy more tokens;
                                                                                                                                                                                                                                                                                                                                                                                                                                </a>;
                                                                                                                                                                                                                                                                                                                                                                                                                                </div>,
                                                                                                                                                                                                                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                                                                                                                                                                                                                    autoClose: 10000,
                                                                                                                                                                                                                                                                                                                                                                                                                                    closeOnClick: false,
                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                    throw new Error(
                                                                                                                                                                                                                                                                                                                                                                                                                                    "Insufficient token balance. You need at least " + std::to_string(minimumRequired.toLocaleString()) + " tokens."
                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                    errorMessage = response.text();
                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                    std::cerr << "Error parsing error response:" << e << std::endl;
                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                std::cerr << "API error response:" << errorData || errorMessage << std::endl;
                                                                                                                                                                                                                                                                                                                                                                                                                                throw std::runtime_error(errorMessage);
                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                            // Parse the response
                                                                                                                                                                                                                                                                                                                                                                                                                            std::any data = nullptr;
                                                                                                                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                                                                                                                const auto contentType = response.headers.get("content-type");
                                                                                                                                                                                                                                                                                                                                                                                                                                if (contentType && contentType.includes("application/json")) {
                                                                                                                                                                                                                                                                                                                                                                                                                                    data = response.json();
                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                        throw std::runtime_error(`Unexpected content type: ${contentType}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                    } catch (jsonError) {
                                                                                                                                                                                                                                                                                                                                                                                                                                        std::cerr << "Error parsing JSON response:" << jsonError << std::endl;
                                                                                                                                                                                                                                                                                                                                                                                                                                        throw std::runtime_error("Failed to parse server response");
                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                    // Validate response
                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!data || typeof data != "object") {
                                                                                                                                                                                                                                                                                                                                                                                                                                        throw std::runtime_error("Invalid response format");
                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                    if (data.success && data.mediaUrl) {
                                                                                                                                                                                                                                                                                                                                                                                                                                        // It's a URL, make sure it's absolute
                                                                                                                                                                                                                                                                                                                                                                                                                                        const auto fullUrl = data.mediaUrl.startsWith("http");
                                                                                                                                                                                                                                                                                                                                                                                                                                        ? data.mediaUrl;
                                                                                                                                                                                                                                                                                                                                                                                                                                        ": " + env.apiUrl + std::to_string(data.mediaUrl.startsWith("/") ? "" : "/") + data.mediaUrl

                                                                                                                                                                                                                                                                                                                                                                                                                                        setGeneratedImage(fullUrl); // We'll reuse this state for audio too;
                                                                                                                                                                                                                                                                                                                                                                                                                                        setEditableLyrics(data.lyrics);
                                                                                                                                                                                                                                                                                                                                                                                                                                        setProcessingStatus("processed");

                                                                                                                                                                                                                                                                                                                                                                                                                                        if (data.remainingGenerations != undefined) {
                                                                                                                                                                                                                                                                                                                                                                                                                                            toast.success(;
                                                                                                                                                                                                                                                                                                                                                                                                                                            "Audio generated successfully! You have " + data.remainingGenerations + " generations left today."
                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                toast.success("Audio generated successfully!");
                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                std::cerr << "Invalid response:" << data << std::endl;
                                                                                                                                                                                                                                                                                                                                                                                                                                                throw new Error(
                                                                                                                                                                                                                                                                                                                                                                                                                                                data.error || "Failed to generate audio: No media URL returned",
                                                                                                                                                                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                            } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                std::cerr << "Error generating audio:" << error << std::endl;
                                                                                                                                                                                                                                                                                                                                                                                                                                                setProcessingStatus("failed");
                                                                                                                                                                                                                                                                                                                                                                                                                                                toast.error(;
                                                                                                                                                                                                                                                                                                                                                                                                                                                true /* instanceof check */ ? error.message : "Failed to generate audio",
                                                                                                                                                                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                                                                                                                                                                // Re-set placeholder if generation failed and we have additional images
                                                                                                                                                                                                                                                                                                                                                                                                                                                if (additionalImages.length > 0 && !placeholderImage) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto randomIndex = Math.floor(Math.random() * additionalImages.size());
                                                                                                                                                                                                                                                                                                                                                                                                                                                    setPlaceholderImage(additionalImages[randomIndex]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                } finally {
                                                                                                                                                                                                                                                                                                                                                                                                                                                    setIsGenerating(false);
                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                };

                                                                                                                                                                                                                                                                                                                                                                                                                                                // Add an effect to inject media type buttons into header container
                                                                                                                                                                                                                                                                                                                                                                                                                                                useEffect(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto headerContainer = document.getElementById("media-selector-container");
                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!headerContainer) return;

                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Create media type buttons container
                                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto mediaTypeButtons = document.createElement("div");
                                                                                                                                                                                                                                                                                                                                                                                                                                                    mediaTypeButtons.className = "flex space-x-2 items-center";

                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Add image button
                                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto imageButton = document.createElement("button");
                                                                                                                                                                                                                                                                                                                                                                                                                                                    imageButton.onclick = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                        setCommunityTab("Image");
                                                                                                                                                                                                                                                                                                                                                                                                                                                        setGeneratedImage(nullptr);
                                                                                                                                                                                                                                                                                                                                                                                                                                                        setProcessingStatus("idle");
                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Set the user prompt back to the token's description when switching to Image tab
                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (tokenInfo.description) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                            setUserPrompt(tokenInfo.description);
                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Re-select placeholder if available
                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (additionalImages.length > 0 && !placeholderImage) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                            const auto randomIndex = Math.floor(Math.random() * additionalImages.size());
                                                                                                                                                                                                                                                                                                                                                                                                                                                            setPlaceholderImage(additionalImages[randomIndex]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                        };
                                                                                                                                                                                                                                                                                                                                                                                                                                                        imageButton.className = communityTab == "Image" ? "active-tab" : "";

                                                                                                                                                                                                                                                                                                                                                                                                                                                        const auto imageImg = document.createElement("img");
                                                                                                                                                                                                                                                                                                                                                                                                                                                        imageImg.src = getTabIconPath("Image", communityTab);
                                                                                                                                                                                                                                                                                                                                                                                                                                                        imageImg.alt = "Image";
                                                                                                                                                                                                                                                                                                                                                                                                                                                        imageImg.className = "cursor-pointer h-8 w-auto";

                                                                                                                                                                                                                                                                                                                                                                                                                                                        imageButton.appendChild(imageImg);
                                                                                                                                                                                                                                                                                                                                                                                                                                                        mediaTypeButtons.appendChild(imageButton);

                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Add video button
                                                                                                                                                                                                                                                                                                                                                                                                                                                        const auto videoButton = document.createElement("button");
                                                                                                                                                                                                                                                                                                                                                                                                                                                        videoButton.onclick = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                            setCommunityTab("Video");
                                                                                                                                                                                                                                                                                                                                                                                                                                                            setGeneratedImage(nullptr);
                                                                                                                                                                                                                                                                                                                                                                                                                                                            setProcessingStatus("idle");
                                                                                                                                                                                                                                                                                                                                                                                                                                                            setUserPrompt(""); // Clear input when switching to Video tab;
                                                                                                                                                                                                                                                                                                                                                                                                                                                            setPlaceholderImage(nullptr); // Clear placeholder for video/audio;
                                                                                                                                                                                                                                                                                                                                                                                                                                                            };
                                                                                                                                                                                                                                                                                                                                                                                                                                                            videoButton.className = communityTab == "Video" ? "active-tab" : "";

                                                                                                                                                                                                                                                                                                                                                                                                                                                            const auto videoImg = document.createElement("img");
                                                                                                                                                                                                                                                                                                                                                                                                                                                            videoImg.src = getTabIconPath("Video", communityTab);
                                                                                                                                                                                                                                                                                                                                                                                                                                                            videoImg.alt = "Video";
                                                                                                                                                                                                                                                                                                                                                                                                                                                            videoImg.className = "cursor-pointer h-8 w-auto";

                                                                                                                                                                                                                                                                                                                                                                                                                                                            videoButton.appendChild(videoImg);
                                                                                                                                                                                                                                                                                                                                                                                                                                                            mediaTypeButtons.appendChild(videoButton);

                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Add audio button
                                                                                                                                                                                                                                                                                                                                                                                                                                                            const auto audioButton = document.createElement("button");
                                                                                                                                                                                                                                                                                                                                                                                                                                                            audioButton.onclick = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                setCommunityTab("Audio");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                setGeneratedImage(nullptr);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                setProcessingStatus("idle");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                setUserPrompt(""); // Clear input when switching to Audio tab;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                setPlaceholderImage(nullptr); // Clear placeholder for video/audio;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                audioButton.className = communityTab == "Audio" ? "active-tab" : "";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                const auto audioImg = document.createElement("img");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                audioImg.src = getTabIconPath("Audio", communityTab);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                audioImg.alt = "Audio";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                audioImg.className = "cursor-pointer h-8 w-auto";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                audioButton.appendChild(audioImg);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                mediaTypeButtons.appendChild(audioButton);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Clear and append to header container
                                                                                                                                                                                                                                                                                                                                                                                                                                                                headerContainer.innerHTML = "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                headerContainer.appendChild(mediaTypeButtons);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Add CSS to document for active tab indication
                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!document.getElementById("media-tab-styles")) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto style = document.createElement("style");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    style.id = "media-tab-styles";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "style.innerHTML = ";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .active-tab {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        position: relative;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .active-tab::after {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        content: "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        position: absolute;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        bottom: -4px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        left: 50%;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        transform: translateX(-50%);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        width: 24px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        height: 2px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        background-color: #03FF24;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    `;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.head.appendChild(style);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Cleanup function to remove the buttons when component unmounts
                                                                                                                                                                                                                                                                                                                                                                                                                                                                return [&]() {;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (headerContainer) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        headerContainer.innerHTML = "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto styleElem = document.getElementById("media-tab-styles");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (styleElem) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        styleElem.remove();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }, [communityTab, additionalImages, tokenInfo.description]); // Rerun when tab, additional images, or token description changes;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Sets the placeholder image to randomly select one image, only for Image tab
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    useEffect(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Only set placeholder if on Image tab, no generated image exists, and we have additional images
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        communityTab == "Image" &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        !generatedImage &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        additionalImages.size() > 0 &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        !placeholderImage // Avoid resetting if one is already chosen;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Select a random image from available images instead of always using the first one
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const auto randomIndex = Math.floor(Math.random() * additionalImages.size());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const auto randomImage = additionalImages[randomIndex];

                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Verify the image loads
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const auto img = new Image();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            img.onload = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                setPlaceholderImage(randomImage);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                img.onerror = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    std::cout << "Placeholder image failed to load: " + randomImage << std::endl;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // If random image fails, try the others sequentially
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto imageLoaders = additionalImages;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .filter((_, i) => i != randomIndex) // Skip the one that just failed;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .map((url) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return new Promise<string | nullptr>((resolve) => {;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const auto imgLoader = new Image();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            imgLoader.onload = () => resolve(url);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            imgLoader.onerror = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                std::cout << "Placeholder image failed to load: " + url << std::endl;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                resolve(nullptr);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                imgLoader.src = url;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Promise.all(imageLoaders).then((results) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto validImage = results.find((url) => url != nullptr);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (validImage) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        setPlaceholderImage(validImage);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    img.src = randomImage;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else if (communityTab != "Image") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Clear placeholder if not on Image tab
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        setPlaceholderImage(nullptr);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }, [generatedImage, additionalImages, communityTab, tokenInfo.image]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Determine the image source to display
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto displayImageSource =;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    generatedImage || placeholderImage || tokenInfo.image;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Condition to show download/share buttons
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto isProcessing = processingStatus == "processing"; // Explicitly check if it IS processing;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const auto shouldShowActions =;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Show if generated media is processed successfully
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    (generatedImage && processingStatus == "processed") ||;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // OR Show if placeholder is visible (only on Image tab and not generating)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    (communityTab == "Image" &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    placeholderImage &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    !generatedImage &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    !isProcessing); // Use the negation of the explicit check;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return (;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="flex flex-col">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="flex flex-col md:flex-row gap-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {/* Content Area */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className="flex flex-col grow w-full">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {/* Main generation controls - consistent across all media types */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className="flex flex-col w-full">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {/* Input Area */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="w-full pt-2">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <textarea;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    rows={3}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                value={userPrompt}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onChange={(e) => setUserPrompt(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onKeyDown={(e) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (e.key == "Enter" && !e.shiftKey && !isGenerating) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Allow Shift+Enter for newlines
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    e.preventDefault(); // Prevent default Enter behavior (newline in textarea);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (communityTab == "Image") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        generateImage();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else if (communityTab == "Video") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (videoMode == "text") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                generateVideo();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else if (;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                videoMode == "image" &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                selectedImageForVideo;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    generateVideo(true, selectedImageForVideo);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else if (communityTab == "Audio") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    generateAudio();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        placeholder={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            communityTab == "Image";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ? "Enter a concept like "a halloween token about arnold schwarzenegger"";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            : communityTab == "Video"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ? videoMode == "text";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ? "Enter a concept for your video";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            : "Enter a description for your video (optional)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            : "Optional: describe the musical style (e.g., "upbeat electronic with retro synths")"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        className="w-full border-b border-b-[#03FF24] text-white bg-transparent focus:outline-none focus:border-b-white px-2 py-2 text-base resize-none leading-normal" // Use py-2, leading-normal for textarea
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        />;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {/* Controls row - moved below input */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="flex items-center justify-end pb-4">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {/* Fast/Pro mode buttons - only show for Image and Video */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {communityTab != "Audio" && (;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className="flex space-x-1 h-10 mr-4">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {" "}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {/* Added margin */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <Tooltip anchorSelect="#faston">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <span>Fast</span>;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </Tooltip>;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <button;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        id="faston";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    onClick={() => setGenerationMode("fast")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    className="cursor-pointer h-10";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    >;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <img;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    src={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        generationMode == "fast";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ? "/token/faston.svg";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        : "/token/fastoff.svg"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    alt="Fast mode";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    className="h-10 w-auto cursor-pointer";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    />;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </button>;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <Tooltip anchorSelect="#promode">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span>Pro</span>;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </Tooltip>;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    id="promode";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                onClick={() => setGenerationMode("pro")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                className="cursor-pointer h-10";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                >;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                <img;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                src={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    generationMode == "pro";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ? "/token/proon.svg";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    : "/token/prooff.svg"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                alt="Pro mode";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                className="h-10 w-auto cursor-pointer";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                />;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                </button>;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                                                                                                                                                                                            )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                        {/* Generate button */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                        <button;
                                                                                                                                                                                                                                                                                                                                                                                                                                                        onClick={() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (communityTab == "Image") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                generateImage();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else if (communityTab == "Video") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (videoMode == "text") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        generateVideo();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else if (videoMode == "image" && selectedImageForVideo) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            generateVideo(true, selectedImageForVideo);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else if (communityTab == "Audio") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            generateAudio();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    disabled={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        isGenerating ||;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (communityTab == "Image" &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (!userPrompt.trim() ||;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (tokenBalance || 0) <;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (generationMode == "pro" ? 10000 : 1000))) ||
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (communityTab == "Video" &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        videoMode == "text" &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (!userPrompt.trim() ||;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (tokenBalance || 0) <;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (generationMode == "fast" ? 10000 : 100000))) ||
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (communityTab == "Video" &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        videoMode == "image" &&;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (!selectedImageForVideo ||;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (tokenBalance || 0) <;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (generationMode == "fast" ? 10000 : 100000))) ||
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (communityTab == "Audio" && (tokenBalance || 0) < 10000);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    className="transition-colors disabled:opacity-50 flex items-center cursor-pointer" // Removed mx-2, h-12
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    >;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <img;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    src={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        isGenerating;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ? "/create/generating.svg";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        : "/create/generateup.svg"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    alt="Generate";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    className="h-12 w-auto" // Kept h-12;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    onMouseDown={(e) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (!isGenerating)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (e.target).src =;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "/create/generatedown.svg";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    onMouseUp={(e) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (!isGenerating)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (e.target).src =;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "/create/generateup.svg";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                onDragStart={(e) => e.preventDefault()}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                onMouseOut={(e) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!isGenerating)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    (e.target).src =;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "/create/generateup.svg";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                />;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                </button>;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>;

                                                                                                                                                                                                                                                                                                                                                                                                                                                            {/* Video-specific options */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                            {communityTab == "Video" && videoMode == "image" ? (;
                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className="px-4">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                        {/* Image upload area for image-to-video */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="border-2 border-dashed border-gray-600 p-4 mb-4">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                        {selectedImageForVideo ? (;
                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="relative">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                        <img;
                                                                                                                                                                                                                                                                                                                                                                                                                                                    src={selectedImageForVideo}
                                                                                                                                                                                                                                                                                                                                                                                                                                                    alt="Selected image";
                                                                                                                                                                                                                                                                                                                                                                                                                                                    className="max-w-full max-h-[300px] mx-auto";
                                                                                                                                                                                                                                                                                                                                                                                                                                                    />;
                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button;
                                                                                                                                                                                                                                                                                                                                                                                                                                                onClick={() => setSelectedImageForVideo(nullptr)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                className="absolute top-2 right-2 bg-black/70 p-1 rounded-full cursor-pointer";
                                                                                                                                                                                                                                                                                                                                                                                                                                                title="Remove image";
                                                                                                                                                                                                                                                                                                                                                                                                                                                >;
                                                                                                                                                                                                                                                                                                                                                                                                                                                <X size={18} />;
                                                                                                                                                                                                                                                                                                                                                                                                                                                </button>;
                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                                                                                                                                                                                ) : (
                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className="text-center py-8">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                <label className="cursor-pointer">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className="mb-2">;
                                                                                                                                                                                                                                                                                                                                                                                                                                                {imageUploadLoading;
                                                                                                                                                                                                                                                                                                                                                                                                                                                ? "Uploading...";
                                                                                                                                                                                                                                                                                                                                                                                                                                            : "Drop an image here or click to upload"}
                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>;
                                                                                                                                                                                                                                                                                                                                                                                                                                            <input;
                                                                                                                                                                                                                                                                                                                                                                                                                                            type="file";
                                                                                                                                                                                                                                                                                                                                                                                                                                            accept="image/*";
                                                                                                                                                                                                                                                                                                                                                                                                                                        onChange={handleImageUpload}
                                                                                                                                                                                                                                                                                                                                                                                                                                        className="hidden";
                                                                                                                                                                                                                                                                                                                                                                                                                                    disabled={imageUploadLoading}
                                                                                                                                                                                                                                                                                                                                                                                                                                    />;
                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="text-blue-400 hover:text-blue-300 text-sm">
                                                                                                                                                                                                                                                                                                                                                                                                                                    {imageUploadLoading ? (;
                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="animate-pulse">Processing...</div>;
                                                                                                                                                                                                                                                                                                                                                                                                                                    ) : (
                                                                                                                                                                                                                                                                                                                                                                                                                                    "Browse files";
                                                                                                                                                                                                                                                                                                                                                                                                                                )}
                                                                                                                                                                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                                                                                                                                                                </label>;
                                                                                                                                                                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                                                                                                                                                            )}
                                                                                                                                                                                                                                                                                                                                                                                                                            </div>;
                                                                                                                                                                                                                                                                                                                                                                                                                            </div>;
                                                                                                                                                                                                                                                                                                                                                                                                                        ) : nullptr}

                                                                                                                                                                                                                                                                                                                                                                                                                    {/* Token balance message */}
                                                                                                                                                                                                                                                                                                                                                                                                                    {communityTab == "Image" &&;
                                                                                                                                                                                                                                                                                                                                                                                                                    (tokenBalance || 0) <;
                                                                                                                                                                                                                                                                                                                                                                                                                    (generationMode == "pro" ? 10000 : 1000) && (
                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="text-sm text-yellow-500 -mt-2">;
                                                                                                                                                                                                                                                                                                                                                                                                                    <p>;
                                                                                                                                                                                                                                                                                                                                                                                                                You need to hold at least{" "}
                                                                                                                                                                                                                                                                                                                                                                                                                {generationMode == "pro" ? "10,000" : "1,000"} tokens to
                                                                                                                                                                                                                                                                                                                                                                                                                generate images in {generationMode} mode.;
                                                                                                                                                                                                                                                                                                                                                                                                                </p>;
                                                                                                                                                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                                                                                                                                            )}

                                                                                                                                                                                                                                                                                                                                                                                                            {communityTab == "Video" &&;
                                                                                                                                                                                                                                                                                                                                                                                                            (tokenBalance || 0) <;
                                                                                                                                                                                                                                                                                                                                                                                                            (generationMode == "fast" ? 10000 : 100000) && (
                                                                                                                                                                                                                                                                                                                                                                                                            <div className="text-sm text-yellow-500 -mt-2">;
                                                                                                                                                                                                                                                                                                                                                                                                            <p>;
                                                                                                                                                                                                                                                                                                                                                                                                        You need to hold at least{" "}
                                                                                                                                                                                                                                                                                                                                                                                                        {generationMode == "fast" ? "10,000" : "100,000"} tokens to
                                                                                                                                                                                                                                                                                                                                                                                                        generate videos in {generationMode} mode.;
                                                                                                                                                                                                                                                                                                                                                                                                        </p>;
                                                                                                                                                                                                                                                                                                                                                                                                        </div>;
                                                                                                                                                                                                                                                                                                                                                                                                    )}

                                                                                                                                                                                                                                                                                                                                                                                                    {communityTab == "Audio" && (tokenBalance || 0) < 10000 && (;
                                                                                                                                                                                                                                                                                                                                                                                                    <div className="text-sm text-yellow-500 -mt-2">;
                                                                                                                                                                                                                                                                                                                                                                                                    <p>;
                                                                                                                                                                                                                                                                                                                                                                                                    You need to hold at least 10,000 tokens to generate audio.;
                                                                                                                                                                                                                                                                                                                                                                                                    </p>;
                                                                                                                                                                                                                                                                                                                                                                                                    </div>;
                                                                                                                                                                                                                                                                                                                                                                                                )}

                                                                                                                                                                                                                                                                                                                                                                                            {/* Generated content display area */}
                                                                                                                                                                                                                                                                                                                                                                                            <div className="flex flex-col relative">;
                                                                                                                                                                                                                                                                                                                                                                                            {processingStatus == "processing" ? (;
                                                                                                                                                                                                                                                                                                                                                                                            // --- Processing Loader ---
                                                                                                                                                                                                                                                                                                                                                                                            <div className="flex items-center justify-center w-full h-[400px] sm:h-[500px] md:h-[600px]">
                                                                                                                                                                                                                                                                                                                                                                                            <div className="flex flex-col items-center">;
                                                                                                                                                                                                                                                                                                                                                                                            <Loader />;
                                                                                                                                                                                                                                                                                                                                                                                            <div className="mt-4 text-autofun-text-secondary font-dm-mono">;
                                                                                                                                                                                                                                                                                                                                                                                            Processing...;
                                                                                                                                                                                                                                                                                                                                                                                            </div>;
                                                                                                                                                                                                                                                                                                                                                                                            </div>;
                                                                                                                                                                                                                                                                                                                                                                                            </div>;
                                                                                                                                                                                                                                                                                                                                                                                            ) : communityTab == "Image" ? (
                                                                                                                                                                                                                                                                                                                                                                                            // --- Image Display ---
                                                                                                                                                                                                                                                                                                                                                                                            <div className="relative w-full aspect-square bg-black">;
                                                                                                                                                                                                                                                                                                                                                                                            {isGenerating ? ( // Show loader overlay during generation phase specifically;
                                                                                                                                                                                                                                                                                                                                                                                            <div className="absolute inset-0 flex flex-col items-center justify-center z-10 bg-black/70">;
                                                                                                                                                                                                                                                                                                                                                                                            <Loader />;
                                                                                                                                                                                                                                                                                                                                                                                            <div className="mt-4 text-autofun-text-secondary font-dm-mono">;
                                                                                                                                                                                                                                                                                                                                                                                            Generating your image...;
                                                                                                                                                                                                                                                                                                                                                                                            </div>;
                                                                                                                                                                                                                                                                                                                                                                                            </div>;
                                                                                                                                                                                                                                                                                                                                                                                        ) : nullptr}
                                                                                                                                                                                                                                                                                                                                                                                        {displayImageSource ? (;
                                                                                                                                                                                                                                                                                                                                                                                        <img;
                                                                                                                                                                                                                                                                                                                                                                                        key={displayImageSource} // Add key to force re-render on source change;
                                                                                                                                                                                                                                                                                                                                                                                    src={displayImageSource}
                                                                                                                                                                                                                                                                                                                                                                                    alt={
                                                                                                                                                                                                                                                                                                                                                                                        generatedImage;
                                                                                                                                                                                                                                                                                                                                                                                        ? "Generated Image";
                                                                                                                                                                                                                                                                                                                                                                                        : placeholderImage
                                                                                                                                                                                                                                                                                                                                                                                        ? "Pregenerated Image";
                                                                                                                                                                                                                                                                                                                                                                                        : tokenInfo.name || "Token Image"
                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                    "className={" + "w-full h-full object-contain " + std::to_string(isGenerating ? "opacity-30" : "")
                                                                                                                                                                                                                                                                                                                                                                                    onError={(e) => {
                                                                                                                                                                                                                                                                                                                                                                                        // Handle potential image load errors, maybe show fallback
                                                                                                                                                                                                                                                                                                                                                                                        console.error(
                                                                                                                                                                                                                                                                                                                                                                                        "Image failed to load:",
                                                                                                                                                                                                                                                                                                                                                                                        e.currentTarget.src,
                                                                                                                                                                                                                                                                                                                                                                                        );
                                                                                                                                                                                                                                                                                                                                                                                        // Optionally set a fallback image or style
                                                                                                                                                                                                                                                                                                                                                                                        e.currentTarget.style.display = "none"; // Hide broken image;
                                                                                                                                                                                                                                                                                                                                                                                        // Maybe show a text error in the parent div
                                                                                                                                                                                                                                                                                                                                                                                        const auto parent = e.currentTarget.parentElement;
                                                                                                                                                                                                                                                                                                                                                                                        if (
                                                                                                                                                                                                                                                                                                                                                                                        parent &&;
                                                                                                                                                                                                                                                                                                                                                                                        !parent.querySelector(".image-error-message");
                                                                                                                                                                                                                                                                                                                                                                                        ) {
                                                                                                                                                                                                                                                                                                                                                                                            const auto errorDiv = document.createElement("div");
                                                                                                                                                                                                                                                                                                                                                                                            errorDiv.className =;
                                                                                                                                                                                                                                                                                                                                                                                            "absolute inset-0 flex items-center justify-center text-red-500 image-error-message";
                                                                                                                                                                                                                                                                                                                                                                                            errorDiv.textContent = "Image failed to load";
                                                                                                                                                                                                                                                                                                                                                                                            parent.appendChild(errorDiv);
                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                    }}
                                                                                                                                                                                                                                                                                                                                                                                    />;
                                                                                                                                                                                                                                                                                                                                                                                    ) : (
                                                                                                                                                                                                                                                                                                                                                                                    // Fallback if no image source is available
                                                                                                                                                                                                                                                                                                                                                                                    <div className="absolute inset-0 flex items-center justify-center text-gray-500">;
                                                                                                                                                                                                                                                                                                                                                                                    No image available;
                                                                                                                                                                                                                                                                                                                                                                                    </div>;
                                                                                                                                                                                                                                                                                                                                                                                )}
                                                                                                                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                                                                                                                ) : communityTab == "Audio" &&
                                                                                                                                                                                                                                                                                                                                                                                generatedImage &&;
                                                                                                                                                                                                                                                                                                                                                                                processingStatus == "processed" ? (;
                                                                                                                                                                                                                                                                                                                                                                                // --- Audio Player with Album Art and Lyrics ---
                                                                                                                                                                                                                                                                                                                                                                                <div className="flex flex-col gap-4 border border-gray-700 p-4 bg-black mb-16">;
                                                                                                                                                                                                                                                                                                                                                                                <div className="flex flex-col md:flex-row gap-4">
                                                                                                                                                                                                                                                                                                                                                                            {/* Album Art */}
                                                                                                                                                                                                                                                                                                                                                                            <div className="w-full md:w-1/2 aspect-square">
                                                                                                                                                                                                                                                                                                                                                                            <img;
                                                                                                                                                                                                                                                                                                                                                                        src={tokenInfo.image || "/logo.png"}
                                                                                                                                                                                                                                                                                                                                                                        alt="Album Art";
                                                                                                                                                                                                                                                                                                                                                                        className="w-full h-full object-cover";
                                                                                                                                                                                                                                                                                                                                                                        />;
                                                                                                                                                                                                                                                                                                                                                                        </div>;

                                                                                                                                                                                                                                                                                                                                                                    {/* Lyrics */}
                                                                                                                                                                                                                                                                                                                                                                    <div className="w-full md:w-1/2 h-[400px] relative">
                                                                                                                                                                                                                                                                                                                                                                    <div className="absolute top-0 right-0 z-10 flex gap-2">;
                                                                                                                                                                                                                                                                                                                                                                    {editableLyrics && (;
                                                                                                                                                                                                                                                                                                                                                                    <>;
                                                                                                                                                                                                                                                                                                                                                                    <CopyButton text={editableLyrics} />;
                                                                                                                                                                                                                                                                                                                                                                    <button;
                                                                                                                                                                                                                                                                                                                                                                    onClick={() =>;
                                                                                                                                                                                                                                                                                                                                                                    setIsEditingLyrics(!isEditingLyrics);
                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                className="p-1 bg-gray-700 rounded hover:bg-gray-600"
                                                                                                                                                                                                                                                                                                                                                                >;
                                                                                                                                                                                                                                                                                                                                                            {isEditingLyrics ? "Save"  = "Edit"}
                                                                                                                                                                                                                                                                                                                                                            </button>;
                                                                                                                                                                                                                                                                                                                                                            <button;
                                                                                                                                                                                                                                                                                                                                                        onClick={() => generateAudio(true)}
                                                                                                                                                                                                                                                                                                                                                        className="p-1 bg-gray-700 rounded hover:bg-gray-600"
                                                                                                                                                                                                                                                                                                                                                    disabled={isGenerating}
                                                                                                                                                                                                                                                                                                                                                    >;
                                                                                                                                                                                                                                                                                                                                                    Regenerate;
                                                                                                                                                                                                                                                                                                                                                    </button>;
                                                                                                                                                                                                                                                                                                                                                    </>;
                                                                                                                                                                                                                                                                                                                                                )}
                                                                                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                                                                                <div className="absolute inset-0 overflow-y-auto">;
                                                                                                                                                                                                                                                                                                                                                {isEditingLyrics ? (;
                                                                                                                                                                                                                                                                                                                                                <textarea;
                                                                                                                                                                                                                                                                                                                                            value={editableLyrics || ""}
                                                                                                                                                                                                                                                                                                                                        onChange={(e) => setEditableLyrics(e.target.value)}
                                                                                                                                                                                                                                                                                                                                        className="w-full h-full p-2 bg-gray-800 text-white font-mono resize-none";
                                                                                                                                                                                                                                                                                                                                        />;
                                                                                                                                                                                                                                                                                                                                        ) : (
                                                                                                                                                                                                                                                                                                                                        <div className="text-white font-mono whitespace-pre-line pt-8">;
                                                                                                                                                                                                                                                                                                                                    {editableLyrics || "No lyrics available"}
                                                                                                                                                                                                                                                                                                                                    </div>;
                                                                                                                                                                                                                                                                                                                                )}
                                                                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                                                                </div>;

                                                                                                                                                                                                                                                                                                                            {/* Audio Player */}
                                                                                                                                                                                                                                                                                                                            <div className="w-full">;
                                                                                                                                                                                                                                                                                                                            <AudioPlayer src={generatedImage} />;
                                                                                                                                                                                                                                                                                                                            </div>;
                                                                                                                                                                                                                                                                                                                            </div>;
                                                                                                                                                                                                                                                                                                                            ) : communityTab == "Video" &&
                                                                                                                                                                                                                                                                                                                            generatedImage &&;
                                                                                                                                                                                                                                                                                                                            processingStatus == "processed" ? (;
                                                                                                                                                                                                                                                                                                                            // --- Video Player ---
                                                                                                                                                                                                                                                                                                                            <div className="border border-gray-700 bg-black mb-16">;
                                                                                                                                                                                                                                                                                                                            <video;
                                                                                                                                                                                                                                                                                                                        src={generatedImage}
                                                                                                                                                                                                                                                                                                                        controls;
                                                                                                                                                                                                                                                                                                                        className="w-full max-h-[500px]";
                                                                                                                                                                                                                                                                                                                        autoPlay;
                                                                                                                                                                                                                                                                                                                        loop;
                                                                                                                                                                                                                                                                                                                        muted // Muted for autoplay policy compliance;
                                                                                                                                                                                                                                                                                                                        >;
                                                                                                                                                                                                                                                                                                                        Your browser does not support the video tag.;
                                                                                                                                                                                                                                                                                                                        </video>;
                                                                                                                                                                                                                                                                                                                        </div>;
                                                                                                                                                                                                                                                                                                                        ) : (
                                                                                                                                                                                                                                                                                                                        // --- Placeholder for Video/Audio before generation ---
                                                                                                                                                                                                                                                                                                                        <div className="flex items-center justify-center w-full h-[400px] sm:h-[500px] md:h-[600px] text-gray-500"></div>
                                                                                                                                                                                                                                                                                                                    )}

                                                                                                                                                                                                                                                                                                                {/* Download and share buttons */}
                                                                                                                                                                                                                                                                                                                {shouldShowActions && (;
                                                                                                                                                                                                                                                                                                                <div className="w-full flex items-center justify-between p-2 bg-gradient-to-t from-black/80 to-transparent absolute bottom-0 left-0 right-0">;
                                                                                                                                                                                                                                                                                                                {shareError && (;
                                                                                                                                                                                                                                                                                                                <div className="text-red-500 text-sm bg-black/50 p-1 rounded mr-auto">;
                                                                                                                                                                                                                                                                                                            {shareError}
                                                                                                                                                                                                                                                                                                            </div>;
                                                                                                                                                                                                                                                                                                        )}
                                                                                                                                                                                                                                                                                                        <div className="ml-auto flex gap-2">;
                                                                                                                                                                                                                                                                                                        <Button;
                                                                                                                                                                                                                                                                                                        size="small";
                                                                                                                                                                                                                                                                                                        variant="outline";
                                                                                                                                                                                                                                                                                                    onClick={downloadMedia}
                                                                                                                                                                                                                                                                                                    // Disable if processing
                                                                                                                                                                                                                                                                                                disabled={isProcessing}
                                                                                                                                                                                                                                                                                                >;
                                                                                                                                                                                                                                                                                                Download;
                                                                                                                                                                                                                                                                                                </Button>;
                                                                                                                                                                                                                                                                                                <Button;
                                                                                                                                                                                                                                                                                                size="small";
                                                                                                                                                                                                                                                                                                variant="secondary";
                                                                                                                                                                                                                                                                                            onClick={shareOnX}
                                                                                                                                                                                                                                                                                            // Disable if already sharing or processing
                                                                                                                                                                                                                                                                                        disabled={isSharing || isProcessing}
                                                                                                                                                                                                                                                                                        >;
                                                                                                                                                                                                                                                                                    {isSharing ? "Sharing..."  = "Share on X"}
                                                                                                                                                                                                                                                                                    </Button>;
                                                                                                                                                                                                                                                                                    </div>;
                                                                                                                                                                                                                                                                                    </div>;
                                                                                                                                                                                                                                                                                )}
                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                                </div>;
                                                                                                                                                                                                                                                                            {/* --- Share Modal --- */}
                                                                                                                                                                                                                                                                            {isShareModalOpen && imageForShareModal && (;
                                                                                                                                                                                                                                                                            <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">;
                                                                                                                                                                                                                                                                            <div className="bg-autofun-background-primary p-6 w-full max-w-lg relative text-white font-dm-mono border-4 border-[#03FF24] shadow-xl">;
                                                                                                                                                                                                                                                                            <button;
                                                                                                                                                                                                                                                                            onClick={() => {
                                                                                                                                                                                                                                                                                setIsShareModalOpen(false);
                                                                                                                                                                                                                                                                                setImageForShareModal(nullptr); // Clear image on close;
                                                                                                                                                                                                                                                                                setIsSharing(false); // Ensure sharing state is reset if modal is cancelled;
                                                                                                                                                                                                                                                                            }}
                                                                                                                                                                                                                                                                            className="absolute top-3 right-3 text-gray-400 hover:text-white cursor-pointer"
                                                                                                                                                                                                                                                                            aria-label="Close modal";
                                                                                                                                                                                                                                                                            >;
                                                                                                                                                                                                                                                                            <X size={20} />;
                                                                                                                                                                                                                                                                            </button>;
                                                                                                                                                                                                                                                                            <h2 className="text-xl font-semibold mb-4 text-[#03FF24]">;
                                                                                                                                                                                                                                                                            Share on X;
                                                                                                                                                                                                                                                                            </h2>;

                                                                                                                                                                                                                                                                        {/* Display the image passed to the modal */}
                                                                                                                                                                                                                                                                        <div className="mb-4 border border-gray-600 overflow-hidden max-h-[300px] flex justify-center items-center bg-gray-800">;
                                                                                                                                                                                                                                                                        <img;
                                                                                                                                                                                                                                                                    src={imageForShareModal}
                                                                                                                                                                                                                                                                    alt="Content to share";
                                                                                                                                                                                                                                                                    className="w-auto h-auto max-w-full max-h-[300px] object-contain";
                                                                                                                                                                                                                                                                    />;
                                                                                                                                                                                                                                                                    </div>;

                                                                                                                                                                                                                                                                    <div className="mb-4">;
                                                                                                                                                                                                                                                                    <label;
                                                                                                                                                                                                                                                                    htmlFor="shareText";
                                                                                                                                                                                                                                                                    className="block text-sm font-medium text-gray-300 mb-1";
                                                                                                                                                                                                                                                                    >;
                                                                                                                                                                                                                                                                    Tweet Text;
                                                                                                                                                                                                                                                                    </label>;
                                                                                                                                                                                                                                                                    <textarea;
                                                                                                                                                                                                                                                                    id="shareText";
                                                                                                                                                                                                                                                                value={modalShareText}
                                                                                                                                                                                                                                                            onChange={(e) => setModalShareText(e.target.value)}
                                                                                                                                                                                                                                                        maxLength={280}
                                                                                                                                                                                                                                                        className="w-full p-2 bg-autofun-background-secondary text-sm border-b border-gray-400 focus:border-white focus:outline-none resize-none"
                                                                                                                                                                                                                                                        placeholder="Edit your tweet text...";
                                                                                                                                                                                                                                                        rows={3} // Give a bit more space;
                                                                                                                                                                                                                                                        />;
                                                                                                                                                                                                                                                        <p className="text-xs text-gray-400 mt-1 text-right">;
                                                                                                                                                                                                                                                        {modalShareText.size()} / 280;
                                                                                                                                                                                                                                                        </p>;
                                                                                                                                                                                                                                                        </div>;

                                                                                                                                                                                                                                                        {shareError && (;
                                                                                                                                                                                                                                                        <p className="text-red-500 text-sm mb-3">Error: {shareError}</p>
                                                                                                                                                                                                                                                    )}

                                                                                                                                                                                                                                                    <div className="flex justify-end gap-3">;
                                                                                                                                                                                                                                                    <Button;
                                                                                                                                                                                                                                                    variant="secondary";
                                                                                                                                                                                                                                                    onClick={() => {
                                                                                                                                                                                                                                                        setIsShareModalOpen(false);
                                                                                                                                                                                                                                                        setImageForShareModal(nullptr); // Clear image on cancel;
                                                                                                                                                                                                                                                        setIsSharing(false); // Ensure sharing state is reset;
                                                                                                                                                                                                                                                    }}
                                                                                                                                                                                                                                                    disabled={isPostingTweet} // Disable cancel if posting is in progress;
                                                                                                                                                                                                                                                    >;
                                                                                                                                                                                                                                                    Cancel;
                                                                                                                                                                                                                                                    </Button>;
                                                                                                                                                                                                                                                    <Button;
                                                                                                                                                                                                                                                    variant="primary";
                                                                                                                                                                                                                                                onClick={confirmAndPostShare}
                                                                                                                                                                                                                                            disabled={isPostingTweet || !modalShareText.trim()}
                                                                                                                                                                                                                                            >;
                                                                                                                                                                                                                                        {isPostingTweet ? "Posting..."  = "Confirm & Post"}
                                                                                                                                                                                                                                        </Button>;
                                                                                                                                                                                                                                        </div>;
                                                                                                                                                                                                                                        </div>;
                                                                                                                                                                                                                                        </div>;
                                                                                                                                                                                                                                    )}
                                                                                                                                                                                                                                    </div>;
                                                                                                                                                                                                                                    );

    } catch (const std::exception& e) {
        std::cerr << "Error: " << e.what() << std::endl;
        throw;
    }
}

} // namespace elizaos
