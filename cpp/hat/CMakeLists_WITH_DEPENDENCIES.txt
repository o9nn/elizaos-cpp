# CMakeLists.txt for HAT Protocol Module
# Includes SQLite3 and OpenSSL dependencies for production-ready implementation

cmake_minimum_required(VERSION 3.14)

# Find required dependencies
find_package(PkgConfig REQUIRED)

# Find OpenSSL (for SHA256 and RAND_bytes)
find_package(OpenSSL REQUIRED)

# Find SQLite3
find_package(SQLite3)
if(NOT SQLite3_FOUND)
    # Try pkg-config as fallback
    pkg_check_modules(SQLITE3 REQUIRED sqlite3)
endif()

# Source files
set(HAT_SOURCES
    src/hat_protocol.cpp
)

# Create the static library
add_library(elizaos-hat STATIC ${HAT_SOURCES})

# Set C++ standard
target_compile_features(elizaos-hat PUBLIC cxx_std_17)

# Include directories
target_include_directories(elizaos-hat PUBLIC
    $<INSTALL_INTERFACE:include>
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../../include>
)

# Link dependencies
if(SQLite3_FOUND)
    target_link_libraries(elizaos-hat PRIVATE
        OpenSSL::SSL
        OpenSSL::Crypto
        SQLite::SQLite3
    )
else()
    target_include_directories(elizaos-hat PRIVATE ${SQLITE3_INCLUDE_DIRS})
    target_link_libraries(elizaos-hat PRIVATE
        OpenSSL::SSL
        OpenSSL::Crypto
        ${SQLITE3_LIBRARIES}
    )
endif()

# Add pthread for Linux
if(UNIX AND NOT APPLE)
    target_link_libraries(elizaos-hat PRIVATE pthread)
endif()

# Compiler options
if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    target_compile_options(elizaos-hat PRIVATE
        -Wall
        -Wextra
        -Wpedantic
        -Werror
    )
elseif(MSVC)
    target_compile_options(elizaos-hat PRIVATE
        /W4
        /WX
    )
endif()

# Define preprocessor flag for real implementation
target_compile_definitions(elizaos-hat PRIVATE
    HAT_REAL_IMPLEMENTATION
)

# Installation rules
install(TARGETS elizaos-hat
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
    RUNTIME DESTINATION bin
)

# Install header files (if any specific to HAT)
# install(FILES include/elizaos/hat.hpp DESTINATION include/elizaos)

# Configuration summary
message(STATUS "HAT Protocol Configuration:")
message(STATUS "  OpenSSL Version: ${OPENSSL_VERSION}")
message(STATUS "  OpenSSL Include: ${OPENSSL_INCLUDE_DIR}")
if(SQLite3_FOUND)
    message(STATUS "  SQLite3 Version: ${SQLite3_VERSION}")
    message(STATUS "  SQLite3 Include: ${SQLite3_INCLUDE_DIRS}")
else()
    message(STATUS "  SQLite3 Version: ${SQLITE3_VERSION}")
    message(STATUS "  SQLite3 Include: ${SQLITE3_INCLUDE_DIRS}")
endif()
message(STATUS "  HAT Real Implementation: ENABLED")

# Optional: Add tests
if(BUILD_TESTING)
    add_subdirectory(tests)
endif()
