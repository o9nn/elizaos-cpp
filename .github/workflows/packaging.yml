name: Build and Package

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-package-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: ubuntu-20.04
            arch: amd64
          - os: ubuntu-22.04
            arch: amd64
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ build-essential libcurl4-openssl-dev pkg-config rpm
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
    
    - name: Build
      run: cmake --build build --config Release -j$(nproc)
    
    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure --config Release
    
    - name: Create DEB package
      working-directory: build
      run: |
        cpack -G DEB
        ls -lh *.deb
    
    - name: Create RPM package
      working-directory: build
      run: |
        cpack -G RPM
        ls -lh *.rpm
    
    - name: Create TGZ archive
      working-directory: build
      run: |
        cpack -G TGZ
        ls -lh *.tar.gz
    
    - name: Upload DEB package
      uses: actions/upload-artifact@v4
      with:
        name: debian-package-${{ matrix.os }}
        path: build/*.deb
        retention-days: 30
    
    - name: Upload RPM package
      uses: actions/upload-artifact@v4
      with:
        name: rpm-package-${{ matrix.os }}
        path: build/*.rpm
        retention-days: 30
    
    - name: Upload TGZ archive
      uses: actions/upload-artifact@v4
      with:
        name: tarball-${{ matrix.os }}
        path: build/*.tar.gz
        retention-days: 30
    
    - name: Test DEB installation
      run: |
        sudo dpkg -i build/*.deb || sudo apt-get install -f -y
        eliza --version || echo "Testing eliza executable..."
        dpkg -L elizaos-cpp | head -20
    
    - name: Publish to GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/*.deb
          build/*.rpm
          build/*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-package-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up MSVC
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.16'
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: cmake --build build --config Release
    
    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure --config Release
    
    - name: Create ZIP package
      working-directory: build
      run: |
        cpack -G ZIP -C Release
        dir *.zip
    
    - name: Create NSIS installer
      working-directory: build
      run: |
        cpack -G NSIS -C Release
        dir *.exe
      continue-on-error: true
    
    - name: Upload ZIP package
      uses: actions/upload-artifact@v4
      with:
        name: windows-zip-package
        path: build/*.zip
        retention-days: 30
    
    - name: Upload NSIS installer
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: build/*.exe
        retention-days: 30
      continue-on-error: true
    
    - name: Publish to GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/*.zip
          build/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-package-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        brew install cmake curl
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local
    
    - name: Build
      run: cmake --build build --config Release -j$(sysctl -n hw.ncpu)
    
    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure --config Release
    
    - name: Create TGZ package
      working-directory: build
      run: |
        cpack -G TGZ
        ls -lh *.tar.gz
    
    - name: Upload TGZ package
      uses: actions/upload-artifact@v4
      with:
        name: macos-tarball
        path: build/*.tar.gz
        retention-days: 30
    
    - name: Publish to GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  package-summary:
    needs: [build-and-package-linux, build-and-package-windows, build-and-package-macos]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display package summary
      run: |
        echo "=== Package Build Summary ==="
        echo ""
        echo "Generated packages:"
        find artifacts -type f | sort
        echo ""
        echo "Package sizes:"
        find artifacts -type f -exec ls -lh {} \; | awk '{print $5, $9}'
        echo ""
        echo "Total packages: $(find artifacts -type f | wc -l)"
