name: Build and Package

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'cpp/**'
      - 'include/**'
      - 'CMakeLists.txt'
      - '.github/workflows/packaging.yml'
      - 'packaging/**'
      - '**.cpp'
      - '**.hpp'
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-package-linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_name: ubuntu-20.04
            arch: amd64
            container: ubuntu:20.04
          - os_name: ubuntu-22.04
            arch: amd64
            container: ubuntu:22.04
    
    container: ${{ matrix.container }}
    
    steps:
    - name: Install git and dependencies
      run: |
        apt-get update
        apt-get install -y git cmake g++ build-essential libcurl4-openssl-dev pkg-config rpm dpkg-dev ca-certificates
    
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
    
    - name: Build
      run: cmake --build build --config Release -j$(nproc)
    
    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure
      continue-on-error: true
    
    - name: Create DEB package
      working-directory: build
      run: |
        echo "Creating DEB package..."
        cpack -G DEB
        ls -lh *.deb || echo "No DEB package created"
    
    - name: Create RPM package
      working-directory: build
      run: |
        echo "Creating RPM package..."
        cpack -G RPM
        ls -lh *.rpm || echo "No RPM package created"
      continue-on-error: true
    
    - name: Create TGZ archive
      working-directory: build
      run: |
        echo "Creating TGZ archive..."
        cpack -G TGZ
        ls -lh *.tar.gz || echo "No TGZ archive created"
    
    - name: Upload DEB package
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: debian-package-${{ matrix.os_name }}-${{ matrix.arch }}
        path: build/*.deb
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload RPM package
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: rpm-package-${{ matrix.os_name }}-${{ matrix.arch }}
        path: build/*.rpm
        retention-days: 30
        if-no-files-found: warn
      continue-on-error: true
    
    - name: Upload TGZ archive
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: tarball-${{ matrix.os_name }}-${{ matrix.arch }}
        path: build/*.tar.gz
        retention-days: 30
        if-no-files-found: warn
    
    - name: Test DEB installation
      if: success()
      run: |
        if ls build/*.deb 1> /dev/null 2>&1; then
          echo "Testing DEB package installation..."
          dpkg -i build/*.deb || apt-get install -f -y
          eliza --version || echo "Eliza executable test..."
          dpkg -L elizaos-cpp | head -20 || echo "Package contents..."
        else
          echo "No DEB package found to test"
        fi
      continue-on-error: true
    
    - name: Publish to GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/*.deb
          build/*.rpm
          build/*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-package-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up MSVC
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.20'
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: cmake --build build --config Release -j 2
    
    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure --config Release
      continue-on-error: true
    
    - name: Create ZIP package
      working-directory: build
      run: |
        echo "Creating ZIP package..."
        cpack -G ZIP -C Release
        dir *.zip
      continue-on-error: true
    
    - name: Install NSIS
      run: |
        choco install nsis -y
      continue-on-error: true
    
    - name: Create NSIS installer
      working-directory: build
      run: |
        echo "Creating NSIS installer..."
        cpack -G NSIS -C Release
        dir *.exe
      continue-on-error: true
    
    - name: Upload ZIP package
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: windows-zip-package
        path: build/*.zip
        retention-days: 30
        if-no-files-found: warn
      continue-on-error: true
    
    - name: Upload NSIS installer
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: build/*.exe
        retention-days: 30
        if-no-files-found: warn
      continue-on-error: true
    
    - name: Publish to GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/*.zip
          build/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

  build-and-package-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        brew install cmake curl pkg-config
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local
    
    - name: Build
      run: cmake --build build --config Release -j$(sysctl -n hw.ncpu)
    
    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure --config Release
      continue-on-error: true
    
    - name: Create TGZ package
      working-directory: build
      run: |
        echo "Creating TGZ package..."
        cpack -G TGZ
        ls -lh *.tar.gz || echo "No TGZ package created"
    
    - name: Upload TGZ package
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: macos-tarball
        path: build/*.tar.gz
        retention-days: 30
        if-no-files-found: warn
    
    - name: Publish to GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  package-summary:
    needs: [build-and-package-linux, build-and-package-windows, build-and-package-macos]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
      continue-on-error: true
    
    - name: Display package summary
      run: |
        echo "=== Package Build Summary ==="
        echo ""
        echo "Generated packages:"
        find artifacts -type f 2>/dev/null | sort || echo "No artifacts found"
        echo ""
        echo "Package sizes:"
        find artifacts -type f -exec ls -lh {} \; 2>/dev/null | awk '{print $5, $9}' || echo "No artifacts found"
        echo ""
        PACKAGE_COUNT=$(find artifacts -type f 2>/dev/null | wc -l)
        echo "Total packages: $PACKAGE_COUNT"
