name: C++ Build and Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'cpp/**'
      - 'include/**'
      - 'CMakeLists.txt'
      - '.github/workflows/cpp-build.yml'
      - 'packaging/**'
      - '**.cpp'
      - '**.hpp'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'cpp/**'
      - 'include/**'
      - 'CMakeLists.txt'
      - '.github/workflows/cpp-build.yml'
      - 'packaging/**'
      - '**.cpp'
      - '**.hpp'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build_type: [Debug, Release]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.20'

    - name: Set up MSVC environment (Windows)
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libcurl4-openssl-dev pkg-config

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake curl pkg-config

    - name: Check C++ compiler availability
      shell: bash
      run: |
        echo "=== Checking C++ Compiler Availability ==="
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          echo "Windows platform detected"
          if command -v cl &> /dev/null; then
            echo "âœ“ MSVC compiler (cl.exe) found in PATH"
            cl.exe /? 2>&1 | head -n 3 || true
          else
            echo "âœ— MSVC compiler (cl.exe) NOT found in PATH"
          fi
        elif [[ "$RUNNER_OS" == "macOS" ]]; then
          echo "macOS platform detected"
          if command -v clang++ &> /dev/null; then
            echo "âœ“ Clang++ compiler found in PATH"
            clang++ --version | head -n 1
          else
            echo "âœ— Clang++ compiler NOT found in PATH"
          fi
        else
          echo "Linux platform detected"
          if command -v g++ &> /dev/null; then
            echo "âœ“ G++ compiler found in PATH"
            g++ --version | head -n 1
          else
            echo "âœ— G++ compiler NOT found in PATH"
          fi
        fi
        echo "==================================="

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }} -j 2

    - name: Test
      working-directory: build
      run: ctest --output-on-failure --config ${{ matrix.build_type }}

    - name: Upload build artifacts
      if: matrix.build_type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: elizaos-cpp-${{ runner.os }}-${{ matrix.build_type }}
        path: |
          build/eliza*
          build/*.exe
          build/*.a
          build/*.lib
        retention-days: 7

  implementation-status:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Analyze Implementation Status
      run: |
        echo "=== ElizaOS C++ Implementation Status ==="
        echo ""
        
        # Count total modules
        TOTAL_MODULES=$(find cpp -maxdepth 1 -type d | grep -v "^cpp$" | wc -l)
        
        # Count placeholder implementations
        PLACEHOLDER_COUNT=$(find cpp -name "placeholder.cpp" | wc -l)
        
        # Count real implementations (modules with substantial code)
        REAL_IMPL_COUNT=$((TOTAL_MODULES - PLACEHOLDER_COUNT))
        
        # Calculate percentage
        if [ $TOTAL_MODULES -gt 0 ]; then
          COMPLETION_PCT=$((REAL_IMPL_COUNT * 100 / TOTAL_MODULES))
        else
          COMPLETION_PCT=0
        fi
        
        echo "ðŸ“Š Implementation Progress:"
        echo "   Total Modules: $TOTAL_MODULES"
        echo "   Implemented: $REAL_IMPL_COUNT ($COMPLETION_PCT%)"
        echo "   Placeholders: $PLACEHOLDER_COUNT"
        echo ""
        
        echo "ðŸš§ Placeholder Modules Remaining:"
        find cpp -name "placeholder.cpp" | sed 's|cpp/||' | sed 's|/src/placeholder.cpp||' | sort || echo "None"
        echo ""
        
        echo "âœ… Fully Implemented Modules:"
        # Find modules without placeholders that have substantial implementations
        for dir in cpp/*/; do
          if [ ! -f "$dir/src/placeholder.cpp" ] && [ -d "$dir" ]; then
            basename "$dir"
          fi
        done | sort
        echo ""
        
        # Set output for use in other steps
        echo "COMPLETION_PCT=$COMPLETION_PCT" >> $GITHUB_ENV
        echo "PLACEHOLDER_COUNT=$PLACEHOLDER_COUNT" >> $GITHUB_ENV
        echo "REAL_IMPL_COUNT=$REAL_IMPL_COUNT" >> $GITHUB_ENV

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ build-essential libcurl4-openssl-dev pkg-config

    - name: Set up CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.20'

    - name: Check C++ compiler availability
      run: |
        echo "=== Checking C++ Compiler Availability ==="
        if command -v g++ &> /dev/null; then
          echo "âœ“ G++ compiler found in PATH"
          g++ --version | head -n 1
        else
          echo "âœ— G++ compiler NOT found in PATH"
        fi
        echo "==================================="

    - name: Configure CMake with strict warnings
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug

    - name: Build with warnings check
      run: |
        cmake --build build 2>&1 | tee build.log
        if grep -i "error:" build.log; then
          echo "Build contains errors"
          exit 1
        else
          echo "Build completed successfully"
        fi
